---
title: "Berlin CO2 Leistungsbild"
author: "Bhaskar Kamble"
date: "15 August 2019"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    theme: united
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message=FALSE,warning=FALSE,cache=FALSE)
```

# <font size="20">Teil 1.</font>

General Notes:

Have all co2 emissions for the Bezirke ready, then add then up to find the co2 for berlin

You can compare the sum of all bezirke with the total for Berlin also

Use this:

file:///D:/GITHUB_REPOS/co2emissions/Berlin/BezirkAnalysis/01_charlottenburg_wilmersdorf/ExtractData2.R


Important variables:

* berlin_co2_all: kilo tons of co2 emitted by each bezirk in each year. (all = mfh+sfh)
* bezirk_areas_all: areas of each bezirk in each year.
* bezirk_spez_co2: per unit area co2 emitted by each bezirk in each year.
* bezirke_spez_co2_linea: linear trend of bezirke_spez_co2
* spez_co2_emission: berlin all buildings, specific co2 emissions for each year
* bezirk_population: population of each bezirk in each year for mfh+sfh.
```{r}
source("D:/GITHUB_REPOS/co2emissions/Berlin/BezirkAnalysis/getAllBezirkeTotalCO2_v2.R")
alle_bezirke_co2 <- getAllBezirkeTotalCO2()
```



```{r}
i_section <- 1
```

# `r i_section`. Alle Stadtbezirke, CO2-Emission aus Beheizung, alle Wohngebäude

```{r}
i_subsection <- 1
```


## `r i_section`.`r i_subsection` Absolute Zahlen


```{r}
i_subsubsection <- 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Berlin, MFH + 1-2 FH, CO2-Emission aus der Beheizung von Wohnraum 2002-2018 in 1.000 t


 * Berlin, summed over all Bezirke and all Energieträger.
 * Berlin, summed over all Bezirke, split by Energieträger.
 
```{r}
#alle_bezirke_co2$all - datatframe of year, and co2 emissions of each bezirk , summed over ET.
berlin_co2_all <- getRowSums(alle_bezirke_co2$all , dropCols = "abrechnungsjahr")
berlin_co2_all
```

```{r}
#plot(berlin_co2_all$abrechnungsjahr , berlin_co2_all$total)
require(ggplot2)
#look at line 187 of BerlinPresentationCO2BalanceUnified_v6.Rmd
points_line_lm <- function(input_data,
                           xVar,
                           yVar,
                           ymin,
                           ymax,
                           x_eq=2008,
                           y_eq=2500,
                           size_eq=6,
                           plot_title,
                           xlab,
                           ylab,
                           slope_round_to = 2,
                           intercept_round_to = 0) {
  linmod <- lm(data=input_data , formula = get(yVar)~get(xVar))
  coeff_a <- as.numeric(coefficients(linmod)[1])
  coeff_b <- as.numeric(coefficients(linmod)[2])
  if (coeff_a<0) {
    sign_coeff_a <- " "
  } else {sign_coeff_a <- "+"}
  
  
  b_round <- as.character(round(coeff_b,slope_round_to))
  a_round <- as.character(round(coeff_a,intercept_round_to))
  lm_equation <- paste0( b_round , "x" , sign_coeff_a ,  a_round)
  
  g <- ggplot() + geom_line(data=input_data , aes(x=get(xVar) , y=get(yVar)) , color="blue"
  )+geom_point(data=input_data , aes(x=get(xVar) , y=get(yVar)) , color="blue"
  )+geom_smooth(method="lm" , data=input_data , aes(x=get(xVar) , y=get(yVar)) , se=FALSE
  )+annotate(geom="text" , label=lm_equation , x = x_eq , y = y_eq , size=size_eq
  )+ylim(ymin,ymax)+scale_x_continuous(breaks=seq(2002,2018,2)
  )+theme_bw()+labs(x=xlab,
  y=ylab,title=plot_title)
  return(g)
}
points_line_lm(input_data = berlin_co2_all,
               xVar = "abrechnungsjahr",
               yVar = "total",
               ymin = 0,
               ymax = max(berlin_co2_all$total),
               x_eq = 2010,
               y_eq = 3600,
               size_eq = 4,
               plot_title = "CO2 emissions in Berlin",
               xlab = "Jahr",
               ylab = "kilo t.")
```



* Now you should write a new function which gives the CO2 emission of Berlin, MFH+SFH, summed over all Bezirke, and split by ET.


```{r}
source("D:/GITHUB_REPOS/co2emissions/Berlin/BezirkAnalysis/getAllBezirkeByETCO2_v2.R")
co2_allebezirke_byET <- getAllBezirkeByETCO2()
co2_all_allebezirke_byET <- co2_allebezirke_byET$all
co2_all_allebezirke_byET
```


```{r}
require(ggplot2)
col_list <- c("royalblue4","orangered1","gray59","orange","blue","olivedrab4")
cols <- c(
          "erdgas"      = "royalblue4",
          "waerme"      = "orangered1",
          "fluessiggas" = "gray59",
          "heizoel"     = "orange",
          "holzpellets" = "blue",
          "strom"       = "olivedrab4"
          )
plot_title <- NULL
order_legend <- rev(c("erdgas","waerme","fluessiggas","heizoel","holzpellets","strom"))
order_labels <- rev(c("Erdgas","Wärme (N+F)","Flüssiggas","Heizöl","Holzpellets","Strom (D+WP)"))
et_list <- c("erdgas","waerme","fluessiggas","heizoel","holzpellets","strom")
plot_byET <- function(obj,xlabel,ylabel,plottitle) {
  ggplot()+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(et_list[1]),color=et_list[1]),size=5
  )+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(et_list[2]),color=et_list[2])
  )+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(et_list[3]),color=et_list[3])
  )+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(et_list[4]),color=et_list[4])
  )+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(et_list[5]),color=et_list[5])
  )+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(et_list[6]),color=et_list[6])
  )+scale_color_manual(labels=order_labels,name=" ",values=cols,breaks=order_legend
  )+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(et_list[6])),fill=col_list[6]
  )+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(et_list[5])),fill=col_list[5]
  )+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(et_list[4])),fill=col_list[4]
  )+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(et_list[3])),fill=col_list[3]
  )+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(et_list[2])),fill=col_list[2]
  )+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(et_list[1])),fill=col_list[1])+theme_bw()+ labs(x=xlabel,y=ylabel,title=plottitle) + theme(plot.title=element_text(size=30), axis.title.x=element_text(size=20, face="bold"), axis.title.y=element_text(size=20, face="bold"), legend.text = element_text(size=15), axis.text.x=element_text(size=15,face="bold"), axis.text.y=element_text(size=15,face="bold"), legend.key.size=unit(2, "lines")
  )+scale_x_continuous(breaks=seq(2002,2018,2))
}
```

```{r}
source("D:/GITHUB_REPOS/co2emissions/Berlin/BezirkAnalysis/getCumSums.R")
co2_all_allebezirke_byET_cumsums <- getCumSums(obj=co2_all_allebezirke_byET , dropCols=c("abrechnungsjahr","total"))
#co2_all_allebezirke_byET_cumsums
plot_byET(co2_all_allebezirke_byET_cumsums , xlabel = "Jahr" , ylabel = "kilo t." , plottitle = NULL)
```

```{r}
i_subsubsection <- i_subsubsection + 1
```





### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, MFH + 1-2 FH, CO2-Emission aus der Beheizung von Wohnraum 2002-2018 summiert in 1.000 t

* Here split by the Bezirke

```{r}
berlin_co2_all
```





```{r}
bezirk_list <- names(berlin_co2_all)[!(names(berlin_co2_all)%in% c("abrechnungsjahr","total"))]
bezirk_list
```

```{r}
berlin_co2_all_cumsums <- getCumSums(obj=berlin_co2_all , dropCols=c("abrechnungsjahr","total"))
```






```{r}
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
cols_bezirk <- gg_color_hue(12)
names(cols_bezirk) <- bezirk_list
order_legend_bez <- bezirk_list
order_labels_bez <- bezirk_list
```





Put it all together into a function:

```{r}
plot_byBezirke <- function(obj,xlabel,ylabel,plottitle) {
ggplot()+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[1]),color=bezirk_list[1]),size=5
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[2]),color=bezirk_list[2])
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[3]),color=bezirk_list[3])
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[4]),color=bezirk_list[4])
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[5]),color=bezirk_list[5])
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[6]),color=bezirk_list[6])
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[7]),color=bezirk_list[7])
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[8]),color=bezirk_list[8])
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[9]),color=bezirk_list[9])
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[10]),color=bezirk_list[10])
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[11]),color=bezirk_list[11])
)+geom_line(data=obj,aes(x=abrechnungsjahr,y=get(bezirk_list[12]),color=bezirk_list[12])
)+scale_color_manual(labels=order_labels_bez,name=" ",values=cols_bezirk,breaks=order_legend_bez
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[12])),fill=cols_bezirk[12]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[11])),fill=cols_bezirk[11]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[10])),fill=cols_bezirk[10]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[9])),fill=cols_bezirk[9]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[8])),fill=cols_bezirk[8]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[7])),fill=cols_bezirk[7]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[6])),fill=cols_bezirk[6]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[5])),fill=cols_bezirk[5]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[4])),fill=cols_bezirk[4]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[3])),fill=cols_bezirk[3]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[2])),fill=cols_bezirk[2]
)+geom_ribbon(data=obj,aes(x=abrechnungsjahr,ymin=0,ymax=get(bezirk_list[1])),fill=cols_bezirk[1]
)+theme_bw()+ labs(x=xlabel,y=ylabel,title=plottitle) + theme(plot.title=element_text(size=10), axis.title.x=element_text(size=10, face="bold"), axis.title.y=element_text(size=10, face="bold"), legend.text = element_text(size=8), axis.text.x=element_text(size=15,face="bold"), axis.text.y=element_text(size=12,face="bold"), legend.key.size=unit(2, "lines"),legend.position = "bottom"
)+scale_x_continuous(breaks=seq(2002,2018,2))
}
```


```{r}
plot_byBezirke(berlin_co2_all_cumsums , xlabel = "Jahr" , ylabel = "kilo t." , plottitle="")
```



```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, MFH + 1-2 FH, CO2-Emission aus der Beheizung von Wohnraum 2002-2018 in Prozent

* Here the percent of the co2 emission broken up by percentage - by ET first, and then by bezirk. 

* The function `find_proportions` is to be used for this purpose.

```{r}
find_proportions
```


```{r}
co2_all_allebezirke_byET
```

```{r}
co2_all_allebezirke_byET_prop <- find_proportions(co2_all_allebezirke_byET , drop_cols = c("abrechnungsjahr","total"))
co2_all_allebezirke_byET_prop
```

```{r}
co2_all_allebezirke_byET_prop_cumsums <- getCumSums(obj=co2_all_allebezirke_byET_prop , dropCols = "abrechnungsjahr")
co2_all_allebezirke_byET_prop_cumsums
```

```{r}
plot_byET(co2_all_allebezirke_byET_prop_cumsums,xlabel = "Jahr" , ylabel = "Anteile in %" , plottitle = NULL)
```



```{r}
berlin_co2_all
```

```{r}
berlin_co2_all_prop <- find_proportions(berlin_co2_all,drop_cols=c("abrechnungsjahr","total"))
berlin_co2_all_prop_cumsums <- getCumSums(berlin_co2_all_prop,dropCols="abrechnungsjahr")
plot_byBezirke(berlin_co2_all_prop_cumsums,xlabel = "Jahr" , ylabel = "Anteile in %" , plottitle = NULL)
```


```{r}
i_subsubsection <- i_subsubsection + 1
```



### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, MFH + 1-2 FH, CO2-Emission aus der Beheizung von Wohnraum 2002-2018 in 1.000 t


```{r}
plot_reqdColumns <- function(input_data,   # data frame
                             xVar,         # column name of "input_data" to be plotted on the x-axis
                             cols_to_plot, #column names of "input_data" to be plotted on the y-axis
                             yColsName,    # for eg. if cols_to_plot = c("Bonn","Berlin"), then this can be City
                             yVar          # for eg. "population" if the columns for "Berlin" etc. show population
) {
  
  input_data <- input_data[ , c(xVar , cols_to_plot)]
  
  #convert data to long format
  require(reshape2)
  input_data <- melt(input_data , id.vars = xVar )
  names(input_data) <- c(xVar , yColsName , yVar)
    
  require(ggplot2)
  return_object <- 
    ggplot(input_data
    )+geom_point(aes(x=get(xVar),y=get(yVar),col=get(yColsName))
    ) + geom_smooth(method="lm",aes(x=get(xVar),y=get(yVar),col=get(yColsName)),se=FALSE
    )+scale_color_discrete(name = yColsName
    )+labs(x=xVar,y=yVar)+ylim(0,max(input_data[[yVar]]))
  
  detach("package:reshape2")
  #detach("package:ggplot2")
 
  return(return_object) 
}
```

(Eine Grafik: co2 Emissionen je Bezirk und Jahr)
Co2 emissions of all city districts by year in a single graph. (year on x-axis and co2 emission on y-axis).
One Graph: Co2 emissions of all city districts by year

```{r}
plot_reqdColumns(berlin_co2_all,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(berlin_co2_all)[!(names(berlin_co2_all) %in% c("abrechnungsjahr","total"))],
                 yColsName = "Bezirk",
                 yVar = "CO2 Emissions")
```



```{r,fig.width=10,fig.height=10}
max_co2_value <- max(berlin_co2_all[ , names(berlin_co2_all)[!(names(berlin_co2_all) %in% c("abrechnungsjahr","total"))]])
require(ggplot2)
g_co2_bezirk <- list()
for (ii in 1:12) {
  g_co2_bezirk[[ii]] <- points_line_lm(input_data = berlin_co2_all,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=0,
                                       ymax=max_co2_value,
                                       x_eq = 2010,
                                       y_eq = 0.5*max_co2_value,
                                       size_eq = 4,
                                       plot_title = bezirk_list[ii],
                                       xlab = "Jahr",
                                       ylab = "kilo tons CO2")
}
require(grid)
require(gridExtra)
grid.arrange(g_co2_bezirk[[1]],g_co2_bezirk[[2]],g_co2_bezirk[[3]],g_co2_bezirk[[4]],
             g_co2_bezirk[[5]],g_co2_bezirk[[6]],g_co2_bezirk[[7]],g_co2_bezirk[[8]],
             g_co2_bezirk[[9]],g_co2_bezirk[[10]],g_co2_bezirk[[11]],g_co2_bezirk[[12]],ncol=3)
```



```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, MFH + 1-2 FH, CO2-Emission aus der Beheizung von Wohnraum 2002-2018, Veränderung in Prozent

```{r}

getDeviationsFromMean <- function(input_data,xVar,colsToAvgOver) {
  input_data <- input_data[ , c(xVar , colsToAvgOver)]
  input_data$meanVal <-  rowMeans(input_data[ , colsToAvgOver])
  for (colName in colsToAvgOver) {
    input_data[[colName]] <- 100.0*(input_data[[colName]] - input_data[["meanVal"]])/input_data[["meanVal"]]
  }
  return(input_data)
}
```

```{r}
berlin_co2_all_devFromMean <- getDeviationsFromMean(berlin_co2_all,
                                                    xVar = "abrechnungsjahr",
                                                    colsToAvgOver = names(berlin_co2_all)[
                                                      !(names(berlin_co2_all
                                                              ) %in% c("abrechnungsjahr","total"))]
)
```

```{r}
berlin_co2_all_devFromMean
```



```{r}
plotDevFromMean <- function(input_data,xVar,yVar,ymin,ymax,ylabel) {
  input_data <- input_data[, c(xVar,yVar)]
  input_data$p_or_m <- as.integer(input_data[[yVar]] > 0)
  input_data$p_or_m[input_data$p_or_m == 0] <- "g_reen"
  input_data$p_or_m[input_data$p_or_m == 1] <- "r_ed"
  return(
    ggplot(data=input_data,aes(x=get(xVar),y=get(yVar),fill=p_or_m))+geom_bar(stat="identity")+scale_fill_manual(values=c("g_reen" = "green", "r_ed" = "red") )+ylim(ymin,ymax)+theme(legend.position="none")+labs(title=yVar,x="Jahr",y=ylabel)
  )
  #
}
```

```{r}
ymin <- min(berlin_co2_all_devFromMean[ , 
                                        names(berlin_co2_all_devFromMean)[
                                          !(names(berlin_co2_all_devFromMean) %in% c("abrechnungsjahr",
                                                                                     "meanVal"))
                                                ]])
ymax <- max(berlin_co2_all_devFromMean[ , 
                                        names(berlin_co2_all_devFromMean)[
                                          !(names(berlin_co2_all_devFromMean) %in% c("abrechnungsjahr",
                                                                                     "meanVal"))
                                                ]])
#plotDevFromMean(berlin_co2_all_devFromMean,"abrechnungsjahr","mitte",yMin=yMin,yMax=yMax)
g_co2dev_bezirk <- list()
for (ii in 1:12) {
  g_co2dev_bezirk[[ii]] <- plotDevFromMean(input_data = berlin_co2_all_devFromMean,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=ymin,
                                       ymax=ymax,
                                       ylabel="% deviation from mean")
}
```

```{r,fig.width=10,fig.height=10}
require(grid)
require(gridExtra)
grid.arrange(g_co2dev_bezirk[[1]],g_co2dev_bezirk[[2]],g_co2dev_bezirk[[3]],g_co2dev_bezirk[[4]],
             g_co2dev_bezirk[[5]],g_co2dev_bezirk[[6]],g_co2dev_bezirk[[7]],g_co2dev_bezirk[[8]],
             g_co2dev_bezirk[[9]],g_co2dev_bezirk[[10]],g_co2dev_bezirk[[11]],g_co2dev_bezirk[[12]],ncol=3)
```

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, MFH + 1-2 FH, CO2-Emission aus der Beheizung von Wohnraum 2002-2018, in Prozent

* Pending


```{r}
i_subsection <- i_subsection + 1
```

## `r i_section`.`r i_subsection` Flächenbezug

```{r}
i_subsubsection <- 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Berlin, MFH + 1-2 FH, flächenbezogene co2 Emission aus der Beheizung von Wohnraum 2002-2018 in kg/m2 [AN]

Here you have to get the areas of SFH and MFH buildings...


* Short method: Do as in BerlinPresentationCO2BalanceUnified_v7.Rmd. I.e. read directly from the file for total Berlin areas.

```{r}
totalArea <- read.table("D:/GITHUB_REPOS/co2emissions/Berlin/berlin_wohnflaeche.txt",header=TRUE)
totalArea <- totalArea*1000000
totalArea$totArea <- rowSums(totalArea)
totalArea$abrechnungsjahr <- 2002:2018
#totalArea <- totalArea[ , c("abrechnungsjahr","totArea")]
totalArea
```



* Long method: find for each bezirk separately, and add them. The units of Bezirk areas are 100 m-squared in the original file. So multiply with 100 to get the areas in m^2.

```{r}
bezirk_areas_sfh <- 100*getRowSums(obj=alle_bezirke_co2$areas_sfh , dropCols = "abrechnungsjahr")
bezirk_areas_mfh <- 100*getRowSums(obj=alle_bezirke_co2$areas_mfh , dropCols = "abrechnungsjahr")
bezirk_areas_all <- bezirk_areas_mfh + bezirk_areas_sfh
bezirk_areas_all$abrechnungsjahr <- 2002:2018
bezirk_areas_all
```


*WHY AM I GET A FACTOR OF 1.4 OFF IN THE TWO METHODS ????*

Use the long method.

```{r}
#spz_co2 <- 1e6*berlin_co2_all$total/totalArea$totArea
spz_co2 <- 1e6*berlin_co2_all$total/bezirk_areas_all$total
spez_co2_emission <- data.frame(abrechnungsjahr=2002:2018 , spez_co2 = spz_co2 )
```


```{r}
spez_co2_emission
```

```{r}
points_line_lm(input_data = spez_co2_emission,
               xVar = "abrechnungsjahr",
               yVar = "spez_co2",
               ymin=0,
               ymax=max(spez_co2_emission$spez_co2),
               x_eq = 2010,
               y_eq = 20,
               size_eq = 4,
               plot_title = NULL,
               xlab = "Jahr",
               ylab = "kg/qm")
```



```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, MFH + 1-2 FH, flächenbezogene co2 Emission aus der Beheizung von Wohnraum 2002-2018 in kg/m2 [AN]

*Is this not similar to 7.2.1?*

*Or am I supposed to show the pictures of all the bezirke simultaneously?*




```{r}
#berlin_co2_all
```

```{r}
#bezirk_areas_all
```


```{r}
bezirke_spez_co2 <- 1e6*berlin_co2_all/bezirk_areas_all
bezirke_spez_co2$abrechnungsjahr <- 2002:2018
```

```{r}
bezirke_spez_co2
```

```{r}
bindex <- 5
points_line_lm(input_data = bezirke_spez_co2,
               xVar = "abrechnungsjahr",
               yVar = bezirk_list[bindex],
               ymin=0,
               ymax=max(bezirke_spez_co2[[bezirk_list[bindex]]]),
               x_eq = 2010,
               y_eq = 20,
               size_eq = 4,
               plot_title = bezirk_list[bindex],
               xlab = "Jahr",
               ylab = "kg/qm")
```



```{r}
plot_reqdColumns(bezirke_spez_co2,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(bezirke_spez_co2)[!(names(bezirke_spez_co2) %in% c("abrechnungsjahr","total"))],
                 yColsName = "Bezirk",
                 yVar = "CO2 Emissions in kg/m2")
```


```{r,fig.height=10,fig.width=10}
reqdCols <- names(bezirke_spez_co2)[!(names(bezirke_spez_co2) %in% c("abrechnungsjahr" , "total"))]
ymax <- max(bezirke_spez_co2 [ , reqdCols])
g_co2spez_bezirk <- list()
for (ii in 1:12) {
  g_co2spez_bezirk[[ii]] <- points_line_lm(input_data = bezirke_spez_co2,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=0,
                                       ymax=ymax,
                                       x_eq = 2010,
                                       y_eq = 0.5*ymax,
                                       size_eq = 4,
                                       plot_title = bezirk_list[ii],
                                       xlab = "Jahr",
                                       ylab = "kg/qm")
}
require(grid)
require(gridExtra)
grid.arrange(g_co2spez_bezirk[[1]],g_co2spez_bezirk[[2]],g_co2spez_bezirk[[3]],g_co2spez_bezirk[[4]],
             g_co2spez_bezirk[[5]],g_co2spez_bezirk[[6]],g_co2spez_bezirk[[7]],g_co2spez_bezirk[[8]],
             g_co2spez_bezirk[[9]],g_co2spez_bezirk[[10]],g_co2spez_bezirk[[11]],g_co2spez_bezirk[[12]],ncol=3)
```








```{r}
i_subsubsection <- i_subsubsection + 1
```


### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, MFH + 1-2 FH, flächenbezogene co2 Emission aus der Beheizung von Wohnraum im Jahr 2018 in kg/m2 [AN]


Extract the 2018 values from the above...

```{r}
bezirke_spez_co2_2018 <- bezirke_spez_co2[bezirke_spez_co2$abrechnungsjahr==2018 , ]
bezirke_spez_co2_2018
```

```{r}
bezirke_spezco2_2018 <- as.data.frame(t(bezirke_spez_co2_2018))
bezirke_spezco2_2018$bezirk <- row.names(bezirke_spezco2_2018)
names(bezirke_spezco2_2018) <- c("wert","bezirk")
bezirke_spezco2_2018 <- bezirke_spezco2_2018[bezirke_spezco2_2018$bezirk!="abrechnungsjahr" , ]
bezirke_spezco2_2018
```

Here it makes more sense to put in the values of the linear trend...

```{r}
linearizer <- function(obj,dropCols,xVar) {
  obj_new <- obj[ , !(names(obj) %in% dropCols)]
  feature_list <- names(obj_new)[ !(names(obj_new) %in% c(dropCols,xVar)) ]
  storage <- list()
  for (feature in feature_list) {
    storage[[feature]] <- lm(get(feature) ~ get(xVar) , data = obj)
    obj_new[[feature]] <- as.numeric(predict(storage[[feature]] , newdata = obj))
  }
  return(obj_new)
}
```


```{r}
bezirke_spez_co2_linear <- linearizer(bezirke_spez_co2 , dropCols = NULL , xVar = "abrechnungsjahr")
```


```{r}
bindex <- 5
points_line_lm(input_data = bezirke_spez_co2_linear,
               xVar = "abrechnungsjahr",
               yVar = bezirk_list[bindex],
               ymin=0,
               ymax=max(bezirke_spez_co2[[bezirk_list[bindex]]]),
               x_eq = 2010,
               y_eq = 20,
               size_eq = 4,
               plot_title = bezirk_list[bindex],
               xlab = "Jahr",
               ylab = "kg/qm")
```


```{r}
bezirke_spez_co2_linear_2018 <- bezirke_spez_co2_linear[bezirke_spez_co2_linear$abrechnungsjahr==2018 , ]
bezirke_spezco2_linear_2018 <- as.data.frame(t(bezirke_spez_co2_linear_2018))
bezirke_spezco2_linear_2018$bezirk <- row.names(bezirke_spezco2_linear_2018)
names(bezirke_spezco2_linear_2018) <- c("wert","bezirk")
bezirke_spezco2_linear_2018 <- bezirke_spezco2_linear_2018[!(bezirke_spezco2_linear_2018$bezirk%in%c("abrechnungsjahr","total")) , ]
bezirke_spezco2_linear_2018
```

Now make a bar plot of these.

```{r}
 bezirke_spezco2_linear_2018$bezirk <- factor(
      bezirke_spezco2_linear_2018$bezirk , 
      levels = bezirke_spezco2_linear_2018$bezirk[order(bezirke_spezco2_linear_2018$wert)])
#barplot(bezirke_spezco2_linear_2018$wert)
ggplot(data=bezirke_spezco2_linear_2018,aes(x=bezirk,y=wert,fill=wert))+geom_bar(stat="identity")+scale_fill_gradient(
  low="green",high="red"
)+theme(legend.position="none",axis.text.x=element_text(angle=45,hjust=1))+labs(x=" ")#+coord_flip()
```










```{r}
i_subsubsection <- i_subsubsection + 1
```


### `r i_section`.`r i_subsection`.`r i_subsubsection` Berlin, flächenbezogene co2 Emission aus Beheizung von Wohnraum nach Stadtbezirken, 2002-2008, 2002=100

The per unit area co2 emission when the 2002 value is 100.

`spez_co2_emission` contains the berlin values of the specific co2 emission.
```{r}
spez_co2_emission
```

```{r}
get2002as100 <- function(obj,dropCols) {
  isNotDropCol <- !(names(obj) %in% dropCols)
  for (xvar in names(obj)[isNotDropCol]) {
    obj[[xvar]] <- 100*obj[[xvar]]/obj[[xvar]][1]
  }
  return(obj)
}
```


```{r}
get2002as100(spez_co2_emission , "abrechnungsjahr")
```

```{r}
points_line_lm(input_data = get2002as100(spez_co2_emission , "abrechnungsjahr"),
               xVar = "abrechnungsjahr",
               yVar = "spez_co2",
               ymin=0,
               ymax=110,
               x_eq = 2010,
               y_eq = 60,
               size_eq = 4,
               plot_title = "Berlin pecific co2 emission, with 2002 as 100",
               xlab = "Jahr",
               ylab = " ")
```

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Alle Stadtbezirke, alle Wohngebäude, flächenbezogene co2 Emission aus der Beheizung von Wohnraum, Entwicklung 2002-2018 und Niveau 2018 (Rang-folge)

Take the Berlin specific CO2 emission for 2018 as the baseline, Subtract from this the 2018 value of specific co2 emission of Stadtbezirk X. Do for all the bezirks and make a barplot.

Make a linear trend of `spez_co2_emission`. This is the value for Berlin total. The 2018 value is the baseline.
`bezirke_spezco2_linear_2018` gives the 2018 values of the linear trend for the bezirke.

First find the linear trend:
```{r}
spez_co2_emission_linear <- linearizer(spez_co2_emission,dropCols=NULL,xVar="abrechnungsjahr")
spez_co2_emission_linear_2018 <- spez_co2_emission_linear$spez_co2[spez_co2_emission_linear$abrechnungsjahr==2018]
spez_co2_emission_linear_2018
```



```{r}
bezirke_spezco2_linear_2018
```


```{r}
bezirke_spezco2_linear_2018$dev_from_berlin <- bezirke_spezco2_linear_2018$wert - spez_co2_emission_linear_2018
```

```{r}
bezirke_spezco2_linear_2018
```


```{r}
bezirke_spezco2_linear_2018$bezirk <- factor(
      bezirke_spezco2_linear_2018$bezirk , 
      levels = bezirke_spezco2_linear_2018$bezirk[order(bezirke_spezco2_linear_2018$dev_from_berlin)])
```

```{r}
ggplot(data=bezirke_spezco2_linear_2018,aes(x=bezirk,y=dev_from_berlin,fill=dev_from_berlin))+geom_bar(stat="identity")+scale_fill_gradient(
  low="green",high="red"
)+theme(legend.position="none",axis.text.x=element_text(angle=45,hjust=1))+labs(x=" ")#+coord_flip()
```

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Berlin, alle Wohngebäude, durchschnittliche Emissionsminderung je qm Nutzfläche im Zeitraum 2002-2018

Take the 2012 value of specific co2 emission as the base line. Plot the changes of each year with respect to this value.

`spez_co2_emission` contains the berlin specific co2 emissions.

```{r}
changeFrom2012 <- function(obj) {
  wert2012 <- obj$spez_co2[obj$abrechnungsjahr==2012]
  obj$delta2012 <- obj$spez_co2 - wert2012
  return(obj)
}
barPlot_delta2012 <- function(obj) {
  obj$abrechnungsjahr <- as.character(obj$abrechnungsjahr)
  require(ggplot2)
  return(
    ggplot(data=obj,aes(x=abrechnungsjahr,y=delta2012,fill=delta2012))+geom_bar(stat="identity")+scale_fill_gradient(
      low="green",high="red"
    )+theme(legend.position="none",axis.text.x=element_text(angle=45,hjust=1))+labs(x=" ")
  )
}
```

```{r}
#changeFrom2012(spez_co2_emission)
```

```{r}
barPlot_delta2012(changeFrom2012(spez_co2_emission))
```



```{r}
i_subsection <- i_subsection + 1
```

## `r i_section`.`r i_subsection` Emission pro Einwohner

```{r}
i_subsubsection <- 1
```


### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, alle Wohngebäude, co2-Emission aus der Beheizung von Wohnraum pro Einwohner

```
bezirk_population <- read.csv2("D:/GITHUB_REPOS/co2emissions/Berlin/BezirkAnalysis/PopulationBezirke/BerlinBezirkPopulation.csv",stringsAsFactors = FALSE)
names(bezirk_population) <- c("bezirk",2002:2018)
#converting data from wide to long: http://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/
# look at the reshape2 option. id.vars has to be bezirk
require(reshape2)
bezirk_population <- melt(bezirk_population,id.vars = "bezirk")
#convert $variable and $value to numeric
bezirk_population$variable <- as.character(bezirk_population$variable)
bezirk_population$variable <- as.numeric(bezirk_population$variable)
bezirk_population$value <- gsub("\\.","",bezirk_population$value)
bezirk_population$value <- as.numeric(bezirk_population$value)
names(bezirk_population) <- c("bezirk","abrechnungsjahr","population")

bezirk_population$bezirk[ bezirk_population$bezirk=="Berlin-Mitte"] <- "mitte"
bezirk_population$bezirk[ bezirk_population$bezirk=="Charlottenburg Wilmersdorf"] <- "charlottenburg_wilmersdorf"
bezirk_population$bezirk[ bezirk_population$bezirk=="Friedrichshain - Kreuzberg"] <- "friedrichshain_kreuzberg"
bezirk_population$bezirk[ bezirk_population$bezirk=="Lichtenberg"] <- "lichtenberg"
bezirk_population$bezirk[ bezirk_population$bezirk=="Marzahn-Hellersdorf"] <- "marzahn_hellersdorf"
bezirk_population$bezirk[ bezirk_population$bezirk=="Neukölln"] <- "neukoelln"
bezirk_population$bezirk[ bezirk_population$bezirk=="Pankow"] <- "pankow"
bezirk_population$bezirk[ bezirk_population$bezirk=="Reinickendorf"] <- "reinickendorf"
bezirk_population$bezirk[ bezirk_population$bezirk=="Spandau"] <- "spandau"
bezirk_population$bezirk[ bezirk_population$bezirk=="Steglitz Zehlendorf"] <- "steglitz_zehlendorf"
bezirk_population$bezirk[ bezirk_population$bezirk=="Tempelhof-Schöneberg"] <- "tempelhof_schoeneberg"
bezirk_population$bezirk[ bezirk_population$bezirk=="Treptow-Köpenick"] <- "treptow_koepenick"
bezirk_population
dcast(bezirk_population , abrechnungsjahr~bezirk,value.var = "population")
```




from:	Johannes Hengstenberg <johanneshengstenberg@gmail.com>
to:	Bhaskar Kamble <kbhaskar.iitk@gmail.com>
date:	Jun 17, 2019, 7:46 PM
subject:	Population Data for the Bezirke


from:	Johannes Hengstenberg <johanneshengstenberg@gmail.com>
to:	Bhaskar Kamble <kbhaskar.iitk@gmail.com>
date:	Jun 16, 2019, 3:09 PM
subject:	Population of Berlin

Now you know the population, so can find per capita co2 emissions.
```{r}
source("D:/GITHUB_REPOS/co2emissions/Berlin/BezirkAnalysis/getBerlinBezirkPopulation.R")
bezirk_population <- getBerlinBezirkPopulation()
#bezirk_population
```

```{r}
bezirk_population <- getRowSums(bezirk_population , dropCols = "abrechnungsjahr")
bezirk_population
```





```{r}
berlin_co2_percapita <- 1e6*berlin_co2_all$total / bezirk_population$total
#bezirk_co2_percapita$abrechnungsjahr <- 2002:2018
berlin_co2_percapita <- data.frame( abrechnungsjahr = 2002:2018 , co2_percapita = berlin_co2_percapita)
berlin_co2_percapita
```

```{r}
points_line_lm(input_data = berlin_co2_percapita,
               xVar = "abrechnungsjahr",
               yVar = "co2_percapita",
               ymin=0,
               ymax=max(berlin_co2_percapita$co2_percapita),
               x_eq = 2010,
               y_eq = 500,
               size_eq = 4,
               plot_title = NULL,
               xlab = "Jahr",
               ylab = "kg/head")
```



```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, alle Wohngebäude, CO2-Emission aus der Beheizung von Wohnraum pro Einwohner

*One Graph: CO2 Emissions in kg/head. All 12 lines in a single plot.*

```{r}
#berlin_co2_all
```

```{r}
#bezirk_population
```


```{r}
berlin_bezirke_all_co2perhead <- 1e6*berlin_co2_all/bezirk_population
berlin_bezirke_all_co2perhead$abrechnungsjahr <- 2002:2018
berlin_bezirke_all_co2perhead
```

```{r}
plot_reqdColumns(berlin_bezirke_all_co2perhead,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(berlin_bezirke_all_co2perhead)[!(names(berlin_bezirke_all_co2perhead) %in% c("abrechnungsjahr","total"))],
                 yColsName = "Bezirk",
                 yVar = "co2 kg/head")
```


```{r,fig.height=10,fig.width=10}
max_co2perhead_value <- max(berlin_bezirke_all_co2perhead[ , names(berlin_bezirke_all_co2perhead)[!(names(berlin_bezirke_all_co2perhead) %in% c("abrechnungsjahr","total"))]])
require(ggplot2)
g_co2perhead_bezirk <- list()
for (ii in 1:12) {
  g_co2perhead_bezirk[[ii]] <- points_line_lm(input_data = berlin_bezirke_all_co2perhead,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=0,
                                       ymax=max_co2perhead_value,
                                       x_eq = 2010,
                                       y_eq = 0.5*max_co2perhead_value,
                                       size_eq = 4,
                                       plot_title = bezirk_list[ii],
                                       xlab = "Jahr",
                                       ylab = "CO2 kg/head")
}
require(grid)
require(gridExtra)
grid.arrange(g_co2perhead_bezirk[[1]],g_co2perhead_bezirk[[2]],g_co2perhead_bezirk[[3]],g_co2perhead_bezirk[[4]],
             g_co2perhead_bezirk[[5]],g_co2perhead_bezirk[[6]],g_co2perhead_bezirk[[7]],g_co2perhead_bezirk[[8]],
             g_co2perhead_bezirk[[9]],g_co2perhead_bezirk[[10]],g_co2perhead_bezirk[[11]],g_co2perhead_bezirk[[12]],ncol=3)
```



```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, alle Wohngebäude, co2-Emission pro Einwohner aus der Beheizung von Wohnraum, 2002-2018, 2002=100 



```{r}
berlin_co2_percapita_2002as100 <- get2002as100(berlin_co2_percapita , "abrechnungsjahr")
```

```{r}
points_line_lm(input_data = berlin_co2_percapita_2002as100,
               xVar = "abrechnungsjahr",
               yVar = "co2_percapita",
               ymin=0,
               ymax=max(berlin_co2_percapita_2002as100$co2_percapita),
               x_eq = 2010,
               y_eq = 70,
               size_eq = 4,
               plot_title = NULL,
               xlab = "Jahr",
               ylab = " ")
```



```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, alle Wohngebäude, CO2-Emission pro Einwohner aus der Beheizung von Wohnraum, 2002 - 2018, 2002 = 100

*One Graph: CO2 Emissions with 2002 value = 100 for each Bezirk. All 12 lines on the same plot.*

The following object, modify it

```{r}
berlin_bezirke_all_co2perhead
```

```{r}
get_bezirk_prohead_2002As100 <- function(obj) {
   for (var in names(obj)) {
     wert2002 <- obj[[var]][obj$abrechnungsjahr == 2002]
     obj[[var]] <- obj[[var]]/wert2002
     obj$abrechnungsjahr <- 2002:2018
   }
  obj <- 100*obj
  obj$abrechnungsjahr <- 2002:2018
  return(obj)
}
bezirk_prohead_2002As100_all <- get_bezirk_prohead_2002As100(berlin_bezirke_all_co2perhead)
```


```{r}
plot_reqdColumns(bezirk_prohead_2002As100_all,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(bezirk_prohead_2002As100_all)[!(names(bezirk_prohead_2002As100_all) %in% c("abrechnungsjahr","total"))],
                 yColsName = "Bezirk",
                 yVar = "co2 pro head, 2002=100")
```






```{r}
plot_bezirkeGridPlot <- function(obj,ylabel) {
  max_y_val <- max(obj[ , names(obj)[!(names(obj) %in% c("abrechnungsjahr","total"))]])
  g_return <- list()
  require(ggplot2)
  for (ii in 1:12) {
  g_return[[ii]] <- points_line_lm(input_data = obj,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=0,
                                       ymax=max_y_val,
                                       x_eq = 2010,
                                       y_eq = 0.5*max_y_val,
                                       size_eq = 4,
                                       plot_title = bezirk_list[ii],
                                       xlab = "Jahr",
                                       ylab = ylabel)
  }
  return(g_return)
}
```

```{r}
gg_co2perhead_2002As100 <- plot_bezirkeGridPlot(bezirk_prohead_2002As100_all,ylabel="Per head co2, 2002=100")
```

```{r,fig.width=10,fig.height=10}
#gg_co2perhead_2002As100[[1]]
require(grid)
require(gridExtra)
grid.arrange(gg_co2perhead_2002As100[[1]],gg_co2perhead_2002As100[[2]],gg_co2perhead_2002As100[[3]],gg_co2perhead_2002As100[[4]],
             gg_co2perhead_2002As100[[5]],gg_co2perhead_2002As100[[6]],gg_co2perhead_2002As100[[7]],gg_co2perhead_2002As100[[8]],
             gg_co2perhead_2002As100[[9]],gg_co2perhead_2002As100[[10]],gg_co2perhead_2002As100[[11]],gg_co2perhead_2002As100[[12]],ncol=3)
```











```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, alle Wohngebäude, co2-Emission aus der Beheizung von Wohnraum pro Einwohner, Niveau im Jahr 2018 in t/Einwohner

* Looks like a bar plot is needed here




```{r}
bezirk_co2_percapita <- 1e6*berlin_co2_all/bezirk_population
bezirk_co2_percapita$abrechnungsjahr <- 2002:2018
bezirk_co2_percapita
```



```{r}
bezirk_co2_percapita_linear <- linearizer(bezirk_co2_percapita,dropCols = NULL , xVar = "abrechnungsjahr")
bezirk_co2_percapita_linear
```

* Just for the sake, I can plot for a specific bezirk here...later do it with plotly interactively.

```{r}
bindex <- 1
points_line_lm(input_data = bezirk_co2_percapita,
               xVar = "abrechnungsjahr",
               yVar = bezirk_list[bindex],
               ymin=0,
               ymax=max(bezirk_co2_percapita[[bezirk_list[bindex]]]),
               x_eq = 2010,
               y_eq = 1200,
               size_eq = 4,
               plot_title = bezirk_list[bindex],
               xlab = "Jahr",
               ylab = "kg/head")
```


```{r}
bezirk_co2_percapita_linear_2018 <- bezirk_co2_percapita_linear[bezirk_co2_percapita_linear$abrechnungsjahr==2018 , ]
bezirk_co2_percapita_linear_2018 <- as.data.frame(t(bezirk_co2_percapita_linear_2018))
bezirk_co2_percapita_linear_2018$bezirk <- row.names(bezirk_co2_percapita_linear_2018)
names(bezirk_co2_percapita_linear_2018) <- c("wert","bezirk")
bezirk_co2_percapita_linear_2018 <- bezirk_co2_percapita_linear_2018[bezirk_co2_percapita_linear_2018$bezirk!="abrechnungsjahr" , ]
bezirk_co2_percapita_linear_2018 <- bezirk_co2_percapita_linear_2018[bezirk_co2_percapita_linear_2018$bezirk!="total" , ]
#bezirk_co2_percapita_linear_2018

bezirk_co2_percapita_linear_2018$bezirk <- factor(
      bezirk_co2_percapita_linear_2018$bezirk , 
      levels = bezirk_co2_percapita_linear_2018$bezirk[order(bezirk_co2_percapita_linear_2018$wert)])
ggplot(data=bezirk_co2_percapita_linear_2018,aes(x=bezirk,y=wert))+geom_bar(stat="identity")+coord_flip()
```




```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, alle Wohngebäude, co2-Emission aus der Beheizung von Wohnraum pro Einwohner, Veränderung 2002/2018 in Prozent


*(Zwei Grafiken: absolute values and percentage values of change compared to 2002 and 2018 values as grouped bar charts.)
Group barchart of only 2002 and 2018 values for each city district - either absolute values and percentage.*

Use `bezirk_co2_percapita_linear`. This is the linear version of `bezirk_co2_percapita`, which is the same as `berlin_bezirke_all_co2perhead`.

```{r}
bezirk_co2_percapita_linear
```


CHANGE THE BELOW CODE:
```{r}
is_2002_or_2018 <- bezirk_co2_percapita_linear$abrechnungsjahr==2002 |
  bezirk_co2_percapita_linear$abrechnungsjahr==2018

bezirk_co2_percapita_linear_20022018 <- bezirk_co2_percapita_linear[ is_2002_or_2018 , ]
bezirk_co2_percapita_linear_20022018
```

```{r}
require(reshape2)
data_long <- melt(bezirk_co2_percapita_linear_20022018,id.vars="abrechnungsjahr")
names(data_long) <- c("abrechnungsjahr","bezirk","wert")
data_long <- data_long[ data_long$bezirk!="total" , ]
```

```{r}

plot_groupBar <- function(obj,yVar,ylabel) {
  obj$abrechnungsjahr <- as.factor(as.character(obj$abrechnungsjahr))  
  return(
    ggplot(obj , aes(x=bezirk,y=get(yVar),fill=abrechnungsjahr))+geom_bar(stat="identity", position=position_dodge())+theme(axis.text.x=element_text(angle=45,hjust=1))+labs(x=" ",y=ylabel)
  )
}
plot_groupBar(data_long,"wert","kg/head")
```

```{r}
plot_groupBarPercent <- function(obj) {
  values2002 <- obj$wert[obj$abrechnungsjahr == 2002]
  obj$percentchange <- rep(values2002, each = 2)
  obj$percentchange <- 100*obj$wert/obj$percentchange
  g_return <- plot_groupBar(obj,"percentchange","per capita percent change, 2002=100")
  return(g_return)
}
```



```{r}
plot_groupBarPercent(data_long)
```

```
bezirk_co2_percapita_linear_20022018 <- as.data.frame(t(bezirk_co2_percapita_linear_2018))
bezirk_co2_percapita_linear_2018$bezirk <- row.names(bezirk_co2_percapita_linear_2018)
names(bezirk_co2_percapita_linear_2018) <- c("wert","bezirk")
bezirk_co2_percapita_linear_2018 <- bezirk_co2_percapita_linear_2018[bezirk_co2_percapita_linear_2018$bezirk!="abrechnungsjahr" , ]
bezirk_co2_percapita_linear_2018 <- bezirk_co2_percapita_linear_2018[bezirk_co2_percapita_linear_2018$bezirk!="total" , ]
#bezirk_co2_percapita_linear_2018

bezirk_co2_percapita_linear_2018$bezirk <- factor(
      bezirk_co2_percapita_linear_2018$bezirk , 
      levels = bezirk_co2_percapita_linear_2018$bezirk[order(bezirk_co2_percapita_linear_2018$wert)])
ggplot(data=bezirk_co2_percapita_linear_2018,aes(x=bezirk,y=wert))+geom_bar(stat="identity")+coord_flip()
```


```{r}
i_subsection <- i_subsection + 1
```

## `r i_section`.`r i_subsection` Prognose

* Do the x + I(x^2) analysis.

```{r}
i_subsubsection <- 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Berlin, alle Wohngebäude, Prognose der co2-Emission aus Beheizung 2019-2030 in Mio. t (Trend Polynom 2. Grades)

```{r}
#berlin_co2_all
quadmodel <- lm(total~abrechnungsjahr+I(abrechnungsjahr^2),data=berlin_co2_all)
from2002_till_2030 <- data.frame(abrechnungsjahr=2002:2030)
prognose <- data.frame(abrechnungsjahr = 2002:2030 , pred = as.numeric(predict(quadmodel,newdata=from2002_till_2030)))
ggplot(prognose , aes(x=abrechnungsjahr , y = pred))+geom_point()
```

```{r}
i_subsection <- i_subsection + 1
```

## `r i_section`.`r i_subsection` Diskussion


```{r}
i_section <- i_section+1
i_subsection <- 1
i_subsubsection <- 1
```

# `r i_section`. Alle Stadtbezirke, co2-emission aus Beheizung, 1-2 Familiengebäude

## `r i_section`.`r i_subsection` Absolute Zahlen

### `r i_section`.`r i_subsection`.`r i_subsubsection` Berlin, 1-2 Familiengebäude, co2-Emission aus der Beheizung von Wohnraum 2002-2018 in 1.000 t

```{r}
alle_bezirke_co2$sfh
```

```{r}
berlin_co2_sfh <- getRowSums(alle_bezirke_co2$sfh , dropCols = "abrechnungsjahr")
berlin_co2_sfh
```

```{r}
points_line_lm(input_data = berlin_co2_sfh,
               xVar = "abrechnungsjahr",
               yVar = "total",
               ymin = 0,
               ymax = max(berlin_co2_sfh$total),
               x_eq = 2010,
               y_eq = 700,
               size_eq = 4,
               plot_title = "CO2 emissions in Berlin SFH",
               xlab = "Jahr",
               ylab = "kilo t.")
```



* Now split by ET

```{r}
co2_sfh_allebezirke_byET <- co2_allebezirke_byET$sfh
co2_sfh_allebezirke_byET
```

```{r}
co2_sfh_allebezirke_byET_cumsums <- getCumSums(obj=co2_sfh_allebezirke_byET , dropCols=c("abrechnungsjahr","total"))
#co2_all_allebezirke_byET_cumsums
plot_byET(co2_sfh_allebezirke_byET_cumsums , xlabel = "Jahr" , ylabel = "kilo t." , plottitle = "SFH CO2 Emissions Berlin")
```




```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, 1-2 Familiengebäude, co2-emissionen aus der Beheizung von Wohnraum 2002-2018 summiert in 1.000 t

* Here co2 emissions split by the bezirke

```{r}
berlin_co2_sfh_cumsums <- getCumSums(obj=berlin_co2_sfh , dropCols=c("abrechnungsjahr","total"))
plot_byBezirke(berlin_co2_sfh_cumsums , xlabel = "Jahr" , ylabel = "kilo t." , plottitle="")
```


```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, 1-2 Familiengebäude, co2-emissionen aus der Beheizung von Wohnraum 2002-2018 in Prozent

```{r}
co2_sfh_allebezirke_byET_prop <- find_proportions(co2_sfh_allebezirke_byET , drop_cols = c("abrechnungsjahr","total"))
co2_sfh_allebezirke_byET_prop_cumsums <- getCumSums(obj=co2_sfh_allebezirke_byET_prop , dropCols = "abrechnungsjahr")
plot_byET(co2_sfh_allebezirke_byET_prop_cumsums,xlabel = "Jahr" , ylabel = "Anteile in %" , plottitle = NULL)
```


```{r}
berlin_co2_sfh_prop <- find_proportions(berlin_co2_sfh,drop_cols=c("abrechnungsjahr","total"))
berlin_co2_sfh_prop_cumsums <- getCumSums(berlin_co2_sfh_prop,dropCols="abrechnungsjahr")
plot_byBezirke(berlin_co2_sfh_prop_cumsums,xlabel = "Jahr" , ylabel = "Anteile in %" , plottitle = NULL)
```



```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, 1-2 Familiengebäude, co2-emissionen aus der Beheizung von Wohnraum 2002-2018 in 1.000 t

**BOOKMARK**
```{r}
plot_reqdColumns(berlin_co2_sfh,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(berlin_co2_sfh)[!(names(berlin_co2_sfh) %in% c("abrechnungsjahr","total"))],
                 yColsName = "Bezirk",
                 yVar = "CO2 Emissions")
```


```{r,fig.height=10,fig.width=10}
gg_co2_sfh <- plot_bezirkeGridPlot(berlin_co2_sfh,ylabel="co2 emissions (kilo tons)")
require(grid)
require(gridExtra)
grid.arrange(gg_co2_sfh[[1]],gg_co2_sfh[[2]],gg_co2_sfh[[3]],gg_co2_sfh[[4]],
             gg_co2_sfh[[5]],gg_co2_sfh[[6]],gg_co2_sfh[[7]],gg_co2_sfh[[8]],
             gg_co2_sfh[[9]],gg_co2_sfh[[10]],gg_co2_sfh[[11]],gg_co2_sfh[[12]],ncol=3)
```




```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, 1-2 Familiengebäude, co2-emissionen aus der Beheizung von Wohnraum 2002-2018, Veränderung in Prozent

```{r}
berlin_co2_sfh_devFromMean <- getDeviationsFromMean(berlin_co2_sfh,
                                                    xVar = "abrechnungsjahr",
                                                    colsToAvgOver = names(berlin_co2_sfh)[
                                                      !(names(berlin_co2_sfh
                                                              ) %in% c("abrechnungsjahr","total"))]
)
```

```{r}
ymin <- min(berlin_co2_sfh_devFromMean[ , 
                                        names(berlin_co2_sfh_devFromMean)[
                                          !(names(berlin_co2_sfh_devFromMean) %in% c("abrechnungsjahr",
                                                                                     "meanVal"))
                                                ]])
ymax <- max(berlin_co2_sfh_devFromMean[ , 
                                        names(berlin_co2_sfh_devFromMean)[
                                          !(names(berlin_co2_sfh_devFromMean) %in% c("abrechnungsjahr",
                                                                                     "meanVal"))
                                                ]])
#plotDevFromMean(berlin_co2_all_devFromMean,"abrechnungsjahr","mitte",yMin=yMin,yMax=yMax)
g_co2dev_bezirk <- list()
for (ii in 1:12) {
  g_co2dev_bezirk[[ii]] <- plotDevFromMean(input_data = berlin_co2_sfh_devFromMean,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=ymin,
                                       ymax=ymax,
                                       ylabel="% deviation from mean")
}
```

```{r,fig.width=10,fig.height=10}
require(grid)
require(gridExtra)
grid.arrange(g_co2dev_bezirk[[1]],g_co2dev_bezirk[[2]],g_co2dev_bezirk[[3]],g_co2dev_bezirk[[4]],
             g_co2dev_bezirk[[5]],g_co2dev_bezirk[[6]],g_co2dev_bezirk[[7]],g_co2dev_bezirk[[8]],
             g_co2dev_bezirk[[9]],g_co2dev_bezirk[[10]],g_co2dev_bezirk[[11]],g_co2dev_bezirk[[12]],ncol=3)
```


```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Stadtbezirke, 1-2 Familiengebäude, Veränderung der co2-emissionen aus der Beheizung von Wohnraum 2002-2018 in Prozent

*Skip this

```{r}
i_subsubsection <- 1
i_subsection <- i_subsection+1
```


## `r i_section`.`r i_subsection`. Flächenbezug

### `r i_section`.`r i_subsection`.`r i_subsubsection` Berlin, 1-2 Familiengebäude, flächenbezogene CO2-Emission aus der Beheizung von Wohnraum 2002 - 2018 in kg/m2[AN]

```{r}
bezirk_areas_sfh$abrechnungsjahr <- 2002:2018
bezirk_areas_sfh
```


```{r}
spz_co2_sfh <- 1e6*berlin_co2_sfh$total/bezirk_areas_sfh$total
spez_co2_sfh <- data.frame(abrechnungsjahr=2002:2018 , spez_co2 = spz_co2_sfh )

points_line_lm(input_data = spez_co2_sfh,
               xVar = "abrechnungsjahr",
               yVar = "spez_co2",
               ymin=0,
               ymax=max(spez_co2_sfh$spez_co2),
               x_eq = 2010,
               y_eq = 35,
               size_eq = 4,
               plot_title = "CO2 emission for SFH buildings",
               xlab = "Jahr",
               ylab = "kg/qm")
```


```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, 1-2 Familiengebäude, flächenbezogene CO2-Emission aus Beheizung von Wohnraum 2002 - 2008 in kg/m2[AN]

```{r}
bezirke_spez_co2_sfh <- 1e6*berlin_co2_sfh/bezirk_areas_sfh
bezirke_spez_co2_sfh$abrechnungsjahr <- 2002:2018
```

```{r}
bindex <- 5
points_line_lm(input_data = bezirke_spez_co2_sfh,
               xVar = "abrechnungsjahr",
               yVar = bezirk_list[bindex],
               ymin=0,
               ymax=max(bezirke_spez_co2_sfh[[bezirk_list[bindex]]]),
               x_eq = 2010,
               y_eq = 20,
               size_eq = 4,
               plot_title = bezirk_list[bindex],
               xlab = "Jahr",
               ylab = "kg/qm")
```


```{r}
plot_reqdColumns(bezirke_spez_co2_sfh,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(bezirke_spez_co2_sfh)[!(names(bezirke_spez_co2_sfh) %in% c("abrechnungsjahr","total"))],
                 yColsName = "Bezirk",
                 yVar = "CO2 Emissions in kg/m2")
```


```{r,fig.width=10,fig.height=10}
reqdCols <- names(bezirke_spez_co2_sfh)[!(names(bezirke_spez_co2_sfh) %in% c("abrechnungsjahr" , "total"))]
ymax <- max(bezirke_spez_co2_sfh [ , reqdCols])
g_co2spez_bezirk <- list()
for (ii in 1:12) {
  g_co2spez_bezirk[[ii]] <- points_line_lm(input_data = bezirke_spez_co2_sfh,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=0,
                                       ymax=ymax,
                                       x_eq = 2010,
                                       y_eq = 0.5*ymax,
                                       size_eq = 4,
                                       plot_title = bezirk_list[ii],
                                       xlab = "Jahr",
                                       ylab = "kg/qm")
}
require(grid)
require(gridExtra)
grid.arrange(g_co2spez_bezirk[[1]],g_co2spez_bezirk[[2]],g_co2spez_bezirk[[3]],g_co2spez_bezirk[[4]],
             g_co2spez_bezirk[[5]],g_co2spez_bezirk[[6]],g_co2spez_bezirk[[7]],g_co2spez_bezirk[[8]],
             g_co2spez_bezirk[[9]],g_co2spez_bezirk[[10]],g_co2spez_bezirk[[11]],g_co2spez_bezirk[[12]],ncol=3)
```





```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, 1-2 Familiengebäude, flächenbezogene CO2-Emission aus der Beheizung von Wohnraum im Jahr 2018 in kg/m2[AN]


```{r}
bezirke_spez_co2_sfh_linear <- linearizer(bezirke_spez_co2_sfh , dropCols = NULL , xVar = "abrechnungsjahr")
bindex <- 5
points_line_lm(input_data = bezirke_spez_co2_sfh_linear,
               xVar = "abrechnungsjahr",
               yVar = bezirk_list[bindex],
               ymin=0,
               ymax=max(bezirke_spez_co2_sfh_linear[[bezirk_list[bindex]]]),
               x_eq = 2010,
               y_eq = 20,
               size_eq = 4,
               plot_title = bezirk_list[bindex],
               xlab = "Jahr",
               ylab = "kg/qm")
```


```{r}
bezirke_spez_co2_sfh_linear_2018 <- bezirke_spez_co2_sfh_linear[bezirke_spez_co2_sfh_linear$abrechnungsjahr==2018 , ]
bezirke_spezco2_sfh_linear_2018 <- as.data.frame(t(bezirke_spez_co2_sfh_linear_2018))
bezirke_spezco2_sfh_linear_2018$bezirk <- row.names(bezirke_spezco2_sfh_linear_2018)
names(bezirke_spezco2_sfh_linear_2018) <- c("wert","bezirk")
bezirke_spezco2_sfh_linear_2018 <- bezirke_spezco2_sfh_linear_2018[bezirke_spezco2_sfh_linear_2018$bezirk!="abrechnungsjahr" , ]
bezirke_spezco2_sfh_linear_2018 <- bezirke_spezco2_sfh_linear_2018[bezirke_spezco2_sfh_linear_2018$bezirk!="total" , ]
bezirke_spezco2_sfh_linear_2018
```


```{r}
bezirke_spezco2_sfh_linear_2018$bezirk <- factor(
      bezirke_spezco2_sfh_linear_2018$bezirk , 
      levels = bezirke_spezco2_sfh_linear_2018$bezirk[order(bezirke_spezco2_sfh_linear_2018$wert)])
#barplot(bezirke_spezco2_linear_2018$wert)
ggplot(data=bezirke_spezco2_sfh_linear_2018,aes(x=bezirk,y=wert,fill=wert))+geom_bar(stat="identity")+scale_fill_gradient(low="green ",high="red")+theme(legend.position="none",axis.text.x=element_text(angle=45,hjust=1))+labs(x=" ")#+coord_flip()
```





```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Berlin, 1-2 Familiengebäude, flächenbezogene CO2-Emission aus Beheizung von Wohnraum nach Stadtbezirken, 2002 - 2008, 2002 = 100

```{r}
get2002as100(spez_co2_sfh , "abrechnungsjahr")
```

```{r}
points_line_lm(input_data = get2002as100(spez_co2_sfh , "abrechnungsjahr"),
               xVar = "abrechnungsjahr",
               yVar = "spez_co2",
               ymin=0,
               ymax=110,
               x_eq = 2010,
               y_eq = 60,
               size_eq = 4,
               plot_title = "Berlin specific co2 emission for SFH buildings, with 2002 as 100",
               xlab = "Jahr",
               ylab = " ")
```

```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Alle Stadtbezirke, 1-2 Familiengebäude, flächenbezogene CO2-Emission aus der Beheizung von Wohnraum, Entwicklung 2002 - 2018 und Niveau 2018 (Rang¬folge)

**Take the Berlin specific CO2 emission for 2018 as the baseline, Subtract from this the 2018 value of specific co2 emission of Stadtbezirk X. Do for all the bezirks and make a barplot.**

```{r}
spez_co2_sfh_linear <- linearizer(spez_co2_sfh,dropCols=NULL,xVar="abrechnungsjahr")
spez_co2_sfh_linear_2018 <- spez_co2_sfh_linear$spez_co2[spez_co2_sfh_linear$abrechnungsjahr==2018]
spez_co2_sfh_linear_2018
```

```{r}
#bezirke_spez_co2_sfh_linear_2018
bezirke_spezco2_sfh_linear_2018
```

```{r}
bezirke_spezco2_sfh_linear_2018$dev_from_berlin <- bezirke_spezco2_sfh_linear_2018$wert - spez_co2_sfh_linear_2018
```

```{r}
bezirke_spezco2_sfh_linear_2018
```

```{r}
bezirke_spezco2_sfh_linear_2018$bezirk <- factor(
bezirke_spezco2_sfh_linear_2018$bezirk , 
      levels = bezirke_spezco2_sfh_linear_2018$bezirk[order(bezirke_spezco2_sfh_linear_2018$dev_from_berlin)])
```

```{r}
ggplot(data=bezirke_spezco2_sfh_linear_2018,aes(x=bezirk,y=dev_from_berlin,fill=dev_from_berlin))+geom_bar(stat="identity")+scale_fill_gradient(
  low="green",high="red"
)+theme(legend.position="none",axis.text.x=element_text(angle=45,hjust=1))+labs(x=" ")#+coord_flip()
```



```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Berlin, 1-2 Familiengebäude, durchschnittliche Emissionsminderung je qm Nutzfläche im Zeitraum 2012 - 2018


```{r}
barPlot_delta2012(changeFrom2012(spez_co2_sfh))
```


```{r}
i_subsection <- i_subsection + 1
```

## `r i_section`.`r i_subsection`. Emission pro Einwohner


```{r}
i_subsubsection <- 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, 1-2 Familiengebäude, CO2-Emission aus der Beheizung von Wohnraum pro Einwohner

**I need the data for the population in SFH and MFH buildings**

```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, 1-2 Familiengebäude, CO2-Emission pro Einwohner aus der Beheizung von Wohnraum, 2002 - 2008, 2002 = 100

**I need the data for the population in SFH and MFH buildings**


```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, 1-2 Familiengebäude, CO2-Emissionen aus der Beheizung von Wohnraum pro Einwohner, Niveau im Jahr 2018 in t/Einwohner

**I need the data for the population in SFH and MFH buildings**

```{r}
i_subsubsection <- i_subsubsection+1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, 1-2 Familiengebäude, CO2-Emissionen aus der Beheizung von Wohnraum pro Einwohner, Veränderung 2002 / 2018 in Prozent

**I need the data for the population in SFH and MFH buildings**

```{r}
i_subsection <- i_subsection+1
```

## `r i_section`.`r i_subsection`. Prognose



```{r}
i_subsubsection <- 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection` Berlin, 1-2 Familiengebäude, Prognose der CO2-Emission aus der Beheizung 2019-2030 in Mio. t (Trend Polynom 2. Grades)

```{r}
quadmodel_sfh <- lm(total~abrechnungsjahr+I(abrechnungsjahr^2),data=berlin_co2_sfh)
from2002_till_2030 <- data.frame(abrechnungsjahr=2002:2030)
prognose_sfh <- data.frame(abrechnungsjahr = 2002:2030 , pred = as.numeric(predict(quadmodel_sfh,newdata=from2002_till_2030)))
ggplot(prognose_sfh , aes(x=abrechnungsjahr , y = pred))+geom_point()
```

```{r}
i_subsection <- i_subsection + 1
```

## `r i_section`.`r i_subsection`. Diskussion











```{r}
i_section <- i_section + 1
```

# `r i_section`. Alle Stadtbezirke, CO2-Emission aus Beheizung, Mehrfamiliengebäude

```{r}
i_subsection <- 1
```

## `r i_section`.`r i_subsection`. Absolute Zahlen 

```{r}
i_subsubsection <- 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Berlin, Mehrfamiliengebäude, CO2-Emission aus der Beheizung von Wohnraum 2002 - 2018 in 1.000 t

```{r}
berlin_co2_mfh <- getRowSums(alle_bezirke_co2$mfh , dropCols = "abrechnungsjahr")
berlin_co2_mfh
```

```{r}
points_line_lm(input_data = berlin_co2_mfh,
               xVar = "abrechnungsjahr",
               yVar = "total",
               ymin = 0,
               ymax = max(berlin_co2_mfh$total),
               x_eq = 2010,
               y_eq = 2000,
               size_eq = 4,
               plot_title = "CO2 emissions in Berlin MFH",
               xlab = "Jahr",
               ylab = "kilo t.")
```


* Now split by ET

```{r}
co2_mfh_allebezirke_byET <- co2_allebezirke_byET$mfh
co2_mfh_allebezirke_byET
```


```{r}
co2_mfh_allebezirke_byET_cumsums <- getCumSums(obj=co2_mfh_allebezirke_byET , dropCols=c("abrechnungsjahr","total"))
co2_mfh_allebezirke_byET_cumsums
```

```{r}
plot_byET(co2_mfh_allebezirke_byET_cumsums , xlabel = "Jahr" , ylabel = "kilo t." , plottitle = "MFH CO2 Emissions Berlin")
```





```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, CO2-Emissionen aus der Beheizung von Wohnraum 2002 - 2018 summiert in 1.000 t 



* Here CO2 emissions split by the bezirke

```{r}
berlin_co2_mfh_cumsums <- getCumSums(obj=berlin_co2_mfh , dropCols=c("abrechnungsjahr","total"))
plot_byBezirke(berlin_co2_mfh_cumsums , xlabel = "Jahr" , ylabel = "kilo t." , plottitle="")
```




```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, CO2-Emissionen aus der Beheizung von Wohnraum 2002 - 2018 in Prozent

```{r}
co2_mfh_allebezirke_byET_prop <- find_proportions(co2_mfh_allebezirke_byET , drop_cols = c("abrechnungsjahr","total"))
co2_mfh_allebezirke_byET_prop_cumsums <- getCumSums(obj=co2_mfh_allebezirke_byET_prop , dropCols = "abrechnungsjahr")
plot_byET(co2_mfh_allebezirke_byET_prop_cumsums,xlabel = "Jahr" , ylabel = "Anteile in %" , plottitle = NULL)
```


```{r}
berlin_co2_mfh_prop <- find_proportions(berlin_co2_mfh,drop_cols=c("abrechnungsjahr","total"))
berlin_co2_mfh_prop_cumsums <- getCumSums(berlin_co2_mfh_prop,dropCols="abrechnungsjahr")
plot_byBezirke(berlin_co2_mfh_prop_cumsums,xlabel = "Jahr" , ylabel = "Anteile in %" , plottitle = NULL)
```




```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, CO2-Emissionen aus der Beheizung von Wohnraum 2002 - 2018 in 1.000 t

(Eine Grafik: co2 Emissionen je Bezirk und Jahr)
Co2 emissions of all city districts by year in a single graph. (year on x-axis and co2 emission on y-axis).
One Graph: Co2 emissions of all city districts by year

```{r}
plot_reqdColumns(berlin_co2_mfh,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(berlin_co2_mfh)[!(names(berlin_co2_mfh) %in% c("abrechnungsjahr","total"))],
                 yColsName = "Bezirk",
                 yVar = "CO2 Emissions")
```

```{r,fig.width=10,fig.height=10}
gg_co2_mfh <- plot_bezirkeGridPlot(berlin_co2_mfh,ylabel="co2 emissions (kilo tons)")
require(grid)
require(gridExtra)
grid.arrange(gg_co2_mfh[[1]],gg_co2_mfh[[2]],gg_co2_mfh[[3]],gg_co2_mfh[[4]],
             gg_co2_mfh[[5]],gg_co2_mfh[[6]],gg_co2_mfh[[7]],gg_co2_mfh[[8]],
             gg_co2_mfh[[9]],gg_co2_mfh[[10]],gg_co2_mfh[[11]],gg_co2_mfh[[12]],ncol=3)
```


```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, CO2-Emissionen aus der Beheizung von Wohnraum 2002 - 2018, Veränderung in Prozent


```{r,fig.width=10,fig.height=10}
berlin_co2_mfh_devFromMean <- getDeviationsFromMean(berlin_co2_mfh,
                                                    xVar = "abrechnungsjahr",
                                                    colsToAvgOver = names(berlin_co2_mfh)[
                                                      !(names(berlin_co2_mfh
                                                              ) %in% c("abrechnungsjahr","total"))]
)
ymin <- min(berlin_co2_mfh_devFromMean[ , 
                                        names(berlin_co2_mfh_devFromMean)[
                                          !(names(berlin_co2_mfh_devFromMean) %in% c("abrechnungsjahr",
                                                                                     "meanVal"))
                                                ]])
ymax <- max(berlin_co2_mfh_devFromMean[ , 
                                        names(berlin_co2_mfh_devFromMean)[
                                          !(names(berlin_co2_mfh_devFromMean) %in% c("abrechnungsjahr",
                                                                                     "meanVal"))
                                                ]])
#plotDevFromMean(berlin_co2_all_devFromMean,"abrechnungsjahr","mitte",yMin=yMin,yMax=yMax)
g_co2dev_bezirk <- list()
for (ii in 1:12) {
  g_co2dev_bezirk[[ii]] <- plotDevFromMean(input_data = berlin_co2_mfh_devFromMean,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=ymin,
                                       ymax=ymax,
                                       ylabel="% deviation from mean")
}
require(grid)
require(gridExtra)
grid.arrange(g_co2dev_bezirk[[1]],g_co2dev_bezirk[[2]],g_co2dev_bezirk[[3]],g_co2dev_bezirk[[4]],
             g_co2dev_bezirk[[5]],g_co2dev_bezirk[[6]],g_co2dev_bezirk[[7]],g_co2dev_bezirk[[8]],
             g_co2dev_bezirk[[9]],g_co2dev_bezirk[[10]],g_co2dev_bezirk[[11]],g_co2dev_bezirk[[12]],ncol=3)
```


```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, Veränderung der CO2-Emission aus der Beheizung von Wohnraum 2002 - 2018 in Prozent

Skip this



```{r}
i_subsection <- i_subsection + 1
i_subsubsection <- 1
```

## `r i_section`.`r i_subsection`. Flächenbezug

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Berlin, Mehrfamiliengebäude, flächenbezogene CO2-Emission aus der Beheizung von Wohnraum 2002 - 2018 in kg/m2[AN]

```{r}
bezirk_areas_mfh$abrechnungsjahr <- 2002:2018
bezirk_areas_mfh
```

```{r}
spz_co2_mfh <- 1e6*berlin_co2_mfh$total/bezirk_areas_mfh$total
spez_co2_mfh <- data.frame(abrechnungsjahr=2002:2018 , spez_co2 = spz_co2_mfh )

points_line_lm(input_data = spez_co2_mfh,
               xVar = "abrechnungsjahr",
               yVar = "spez_co2",
               ymin=0,
               ymax=max(spez_co2_mfh$spez_co2),
               x_eq = 2010,
               y_eq = 25,
               size_eq = 4,
               plot_title = "CO2 emission for MFH buildings",
               xlab = "Jahr",
               ylab = "kg/qm")
```



```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, flächenbezogene CO2-Emission aus Beheizung von Wohnraum 2002 - 2008 in kg/m2[AN]

BOOKMARK - Section 3.2.2.

```{r}
bezirke_spez_co2_mfh <- 1e6*berlin_co2_mfh/bezirk_areas_mfh
bezirke_spez_co2_mfh$abrechnungsjahr <- 2002:2018
```

```{r}
bindex <- 5
points_line_lm(input_data = bezirke_spez_co2_mfh,
               xVar = "abrechnungsjahr",
               yVar = bezirk_list[bindex],
               ymin=0,
               ymax=max(bezirke_spez_co2_mfh[[bezirk_list[bindex]]]),
               x_eq = 2010,
               y_eq = 20,
               size_eq = 4,
               plot_title = bezirk_list[bindex],
               xlab = "Jahr",
               ylab = "kg/qm")
```

```{r}
plot_reqdColumns(bezirke_spez_co2_mfh,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(bezirke_spez_co2_mfh)[!(names(bezirke_spez_co2_mfh) %in% c("abrechnungsjahr","total"))],
                 yColsName = "Bezirk",
                 yVar = "CO2 Emissions in kg/m2")
```


```{r,fig.height=10,fig.width=10}
reqdCols <- names(bezirke_spez_co2_mfh)[!(names(bezirke_spez_co2_mfh) %in% c("abrechnungsjahr" , "total"))]
ymax <- max(bezirke_spez_co2_mfh [ , reqdCols])
g_co2spez_bezirk <- list()
for (ii in 1:12) {
  g_co2spez_bezirk[[ii]] <- points_line_lm(input_data = bezirke_spez_co2_mfh,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=0,
                                       ymax=ymax,
                                       x_eq = 2010,
                                       y_eq = 0.5*ymax,
                                       size_eq = 4,
                                       plot_title = bezirk_list[ii],
                                       xlab = "Jahr",
                                       ylab = "kg/qm")
}
require(grid)
require(gridExtra)
grid.arrange(g_co2spez_bezirk[[1]],g_co2spez_bezirk[[2]],g_co2spez_bezirk[[3]],g_co2spez_bezirk[[4]],
             g_co2spez_bezirk[[5]],g_co2spez_bezirk[[6]],g_co2spez_bezirk[[7]],g_co2spez_bezirk[[8]],
             g_co2spez_bezirk[[9]],g_co2spez_bezirk[[10]],g_co2spez_bezirk[[11]],g_co2spez_bezirk[[12]],ncol=3)
```


```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, flächenbezogene CO2-Emission aus der Beheizung von Wohnraum im Jahr 2018 in kg/m2[AN]


```{r}
bezirke_spez_co2_mfh_linear <- linearizer(bezirke_spez_co2_mfh , dropCols = NULL , xVar = "abrechnungsjahr")
bindex <- 5
points_line_lm(input_data = bezirke_spez_co2_mfh_linear,
               xVar = "abrechnungsjahr",
               yVar = bezirk_list[bindex],
               ymin=0,
               ymax=max(bezirke_spez_co2_mfh_linear[[bezirk_list[bindex]]]),
               x_eq = 2010,
               y_eq = 20,
               size_eq = 4,
               plot_title = bezirk_list[bindex],
               xlab = "Jahr",
               ylab = "kg/qm")
```



```{r}
bezirke_spez_co2_mfh_linear_2018 <- bezirke_spez_co2_mfh_linear[bezirke_spez_co2_mfh_linear$abrechnungsjahr==2018 , ]
bezirke_spezco2_mfh_linear_2018 <- as.data.frame(t(bezirke_spez_co2_mfh_linear_2018))
bezirke_spezco2_mfh_linear_2018$bezirk <- row.names(bezirke_spezco2_mfh_linear_2018)
names(bezirke_spezco2_mfh_linear_2018) <- c("wert","bezirk")
bezirke_spezco2_mfh_linear_2018 <- bezirke_spezco2_mfh_linear_2018[bezirke_spezco2_mfh_linear_2018$bezirk!="abrechnungsjahr" , ]
bezirke_spezco2_mfh_linear_2018 <- bezirke_spezco2_mfh_linear_2018[bezirke_spezco2_mfh_linear_2018$bezirk!="total" , ]
bezirke_spezco2_mfh_linear_2018
```

```{r}
bezirke_spezco2_mfh_linear_2018$bezirk <- factor(
      bezirke_spezco2_mfh_linear_2018$bezirk , 
      levels = bezirke_spezco2_mfh_linear_2018$bezirk[order(bezirke_spezco2_mfh_linear_2018$wert)])
#barplot(bezirke_spezco2_linear_2018$wert)
ggplot(data=bezirke_spezco2_mfh_linear_2018,aes(x=bezirk,y=wert,fill=wert))+geom_bar(stat="identity")+scale_fill_gradient(low="green ",high="red")+theme(legend.position="none",axis.text.x=element_text(angle=45,hjust=1))+labs(x=" ")#+coord_flip()
```



```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Berlin, Mehrfamiliengebäude, flächenbezogene CO2-Emission aus Beheizung von Wohnraum nach Stadtbezirken, 2002 - 2008, 2002 = 100

```{r}
get2002as100(spez_co2_mfh , "abrechnungsjahr")
```

```{r}
points_line_lm(input_data = get2002as100(spez_co2_mfh , "abrechnungsjahr"),
               xVar = "abrechnungsjahr",
               yVar = "spez_co2",
               ymin=0,
               ymax=110,
               x_eq = 2010,
               y_eq = 60,
               size_eq = 4,
               plot_title = "Berlin specific co2 emission for MFH buildings, with 2002 as 100",
               xlab = "Jahr",
               ylab = " ")
```



```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Alle Stadtbezirke, Mehrfamiliengebäude, flächenbezogene CO2-Emission aus der Beheizung von Wohnraum, Entwicklung 2002 - 2018 und Niveau 2018 (Rang¬folge)

Take the Berlin specific CO2 emission for 2018 as the baseline, Subtract from this the 2018 value of specific co2 emission of Stadtbezirk X. Do for all the bezirks and make a barplot.

```{r}
spez_co2_mfh_linear <- linearizer(spez_co2_mfh,dropCols=NULL,xVar="abrechnungsjahr")
spez_co2_mfh_linear_2018 <- spez_co2_mfh_linear$spez_co2[spez_co2_mfh_linear$abrechnungsjahr==2018]
spez_co2_mfh_linear_2018
```

```{r}
bezirke_spezco2_mfh_linear_2018
```

```{r}
bezirke_spezco2_mfh_linear_2018$dev_from_berlin <- bezirke_spezco2_mfh_linear_2018$wert - spez_co2_mfh_linear_2018
bezirke_spezco2_mfh_linear_2018$bezirk <- factor(
  bezirke_spezco2_mfh_linear_2018$bezirk , 
  levels = bezirke_spezco2_mfh_linear_2018$bezirk[order(bezirke_spezco2_mfh_linear_2018$dev_from_berlin)])
ggplot(data=bezirke_spezco2_mfh_linear_2018,aes(x=bezirk,y=dev_from_berlin,fill=dev_from_berlin))+geom_bar(stat="identity")+scale_fill_gradient(
  low="green",high="red"
)+theme(legend.position="none",axis.text.x=element_text(angle=45,hjust=1))+labs(x=" ")#+coord_flip()
```


```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Berlin, Mehrfamiliengebäude, durchschnittliche Emissionsminderung je qm Nutzfläche im Zeitraum 2012 - 2018

```{r}
barPlot_delta2012(changeFrom2012(spez_co2_mfh))
```

```{r}
i_subsection <- i_subsection + 1
i_subsubsection <- 1
```

## `r i_section`.`r i_subsection`. Emission pro Einwohner



### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, CO2-Emission aus der Beheizung von Wohnraum pro Einwohner

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, CO2-Emission pro Einwohner aus der Beheizung von Wohnraum, 2002 - 2008, 2002 = 100

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, CO2-Emissionen aus der Beheizung von Wohnraum pro Einwohner, Niveau im Jahr 2018 in t/Einwohner

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Stadtbezirke, Mehrfamiliengebäude, CO2-Emissionen aus der Beheizung von Wohnraum pro Einwohner, Veränderung 2002 / 2018 in Prozent


```{r}
i_subsection <- i_subsection + 1
i_subsubsection <- 1
```

## `r i_section`.`r i_subsection`. Prognose

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Berlin, Mehrfamiliengebäude, Prognose der CO2-Emission aus Behei¬zung 2019 - 2030 in Mio. t (Trend Polynom 2. Grades)

```{r}
quadmodel_mfh <- lm(total~abrechnungsjahr+I(abrechnungsjahr^2),data=berlin_co2_mfh)
from2002_till_2030 <- data.frame(abrechnungsjahr=2002:2030)
prognose_mfh <- data.frame(abrechnungsjahr = 2002:2030 , pred = as.numeric(predict(quadmodel_mfh,newdata=from2002_till_2030)))
ggplot(prognose_mfh , aes(x=abrechnungsjahr , y = pred))+geom_point()
```


Johannes used to use the index of the years, with 0 for 2002, 1 for 2003, and so on. I should do the same:

```{r}
berlin_co2_mfh_temp <- berlin_co2_mfh
berlin_co2_mfh_temp$jahrIndex <- berlin_co2_mfh_temp$abrechnungsjahr - 2002
quadmodel2_mfh <- lm(total~jahrIndex+I(jahrIndex^2),data=berlin_co2_mfh_temp)
from2002_till_2030_index <- data.frame(jahrIndex=(2002:2030) - 2002)
prognose2_mfh <- data.frame(jahrIndex = (2002:2030)-2002 , pred = as.numeric(predict(quadmodel2_mfh,newdata=from2002_till_2030_index)))
ggplot(prognose2_mfh , aes(x=jahrIndex , y = pred))+geom_point()
```

Apparently makes no difference...


```{r}
i_subsection <- i_subsection + 1
```

## `r i_section`.`r i_subsection`. Diskussion




```{r}
i_section <- i_section + 1
i_subsection <- 1
```


# `r i_section`.	Heizenergieverbrauch nach Stadtbezirken 2002 - 2018, alle Wohngebäude 

## `r i_section`.`r i_subsection`.	Stadtbezirke, alle Wohngebäude, Heizenergieverbrauch 2002 - 2018

* `getAllBezirkeTotalCO2.R` and `getAllBezirkeByETCO2.R` both invoke `mainScriptCO2Emissions_v2.R`.
* `mainScriptCO2Emissions_v2.R` creates the attribute `energy_shares_absolute`. This is the energy produced by the respective ETs.
* So modify the returned object in `getAllBezirkeTotalCO2.R` and `getAllBezirkeByETCO2.R` so that it includes the `energy_shares_absolute` as well.



* Total energy split by ET:
```{r}
by_ten_9 <- 1e-9
aes_by_ET_TWh <- by_ten_9 * co2_allebezirke_byET$aes_all
aes_by_ET_TWh$abrechnungsjahr <- 2002:2018
aes_by_ET_TWh_cumsums <- getCumSums(obj=aes_by_ET_TWh , dropCols = c("abrechnungsjahr","total"))
```

```{r}
points_line_lm(input_data = aes_by_ET_TWh,
               xVar = "abrechnungsjahr",
               yVar = "total",
               ymin = 0,
               ymax = max(aes_by_ET_TWh$total),
               x_eq = 2010,
               y_eq = 0.1,
               size_eq = 4,
               plot_title = "Total energy consumption in Berlin",
               xlab = "Jahr",
               ylab = "TWh",
               slope_round_to = 4)
```

```{r}
plot_byET(aes_by_ET_TWh_cumsums , xlabel = "Jahr" , ylabel = "TWh" , plottitle = NULL)
```



* Total energy split by bezirk:
```{r}
by_ten_9 <- 1e-9
aes_by_bezirk_TWh <- by_ten_9 * alle_bezirke_co2$aes_all
aes_by_bezirk_TWh$abrechnungsjahr <- 2002:2018
aes_by_bezirk_TWh_cumsums <- getCumSums(obj=aes_by_bezirk_TWh , dropCols = "abrechnungsjahr")
```

```{r}
plot_byBezirke(aes_by_bezirk_TWh_cumsums , xlabel = "Jahr" , ylabel = "TWh" , plottitle=NULL)
```



```{r}
i_subsection <- i_subsection+1
```

## `r i_section`.`r i_subsection`. Stadtbezirke, alle Wohngebäude, Heizenergieverbrauch 2002 - 2018

Eine Grafik: Heizenergieverbrauch aller 12 Bezirke in einer Grafik)
One Graph: All 12 lines in a single graph.

```{r}
#aes_by_bezirk_kWh <- 1e9 * aes_by_bezirk_TWh
#aes_by_bezirk_kWh$abrechnungsjahr <- 2002:2018
aes_by_bezirk_TWh
```

```{r}
plot_reqdColumns(aes_by_bezirk_TWh,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(aes_by_bezirk_TWh)[!(names(aes_by_bezirk_TWh) %in% c("abrechnungsjahr"))],
                 yColsName = "Bezirk",
                 yVar = "Energy in TWh")
```


```{r,fig.height=10,fig.width=10}
max_aes_value <- max(aes_by_bezirk_TWh[ , names(aes_by_bezirk_TWh)[!(names(aes_by_bezirk_TWh) %in% c("abrechnungsjahr","total"))]])
require(ggplot2)
g_aes_bezirk <- list()
for (ii in 1:12) {
  g_aes_bezirk[[ii]] <- points_line_lm(input_data = aes_by_bezirk_TWh,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=0,
                                       ymax=max_aes_value,
                                       x_eq = 2010,
                                       y_eq = 0.5*max_aes_value,
                                       size_eq = 4,
                                       plot_title = bezirk_list[ii],
                                       xlab = "Jahr",
                                       ylab = "Energy in TWh",
                                       slope_round_to = 4,
                                       intercept_round_to = 2)
}
require(grid)
require(gridExtra)
grid.arrange(g_aes_bezirk[[1]],g_aes_bezirk[[2]],g_aes_bezirk[[3]],g_aes_bezirk[[4]],
             g_aes_bezirk[[5]],g_aes_bezirk[[6]],g_aes_bezirk[[7]],g_aes_bezirk[[8]],
             g_aes_bezirk[[9]],g_aes_bezirk[[10]],g_aes_bezirk[[11]],g_aes_bezirk[[12]],ncol=3)
```





```{r}
i_subsection <- i_subsection+1
```

## `r i_section`.`r i_subsection`.	Stadtbezirke, alle Wohngebäude, flächenbezogener Heizenergieverbrauch 2002 - 2018 in kWh/(m2[AN]*a) 


* `bezirk_areas_all$total` gives the total areas of berlin (MFH+SFH).

* `aes_by_ET_TWh$total` gives the total TWh consumption.

* So the quotient will give the per unit area consumption.

```{r}
spz_verbrauch_all <- data.frame(abrechnungsjahr=2002:2018,
                                kWh_per_m2 = 1e9 * aes_by_ET_TWh$total/bezirk_areas_all$total)
points_line_lm(input_data = spz_verbrauch_all,
               xVar = "abrechnungsjahr",
               yVar = "kWh_per_m2",
               ymin = 0,
               ymax = max(spz_verbrauch_all$kWh_per_m2),
               x_eq = 2010,
               y_eq = 0.8,
               size_eq = 4,
               plot_title = "Specific consumption, all buildings",
               xlab = "Jahr",
               ylab = "kWh/m^2")
```

```{r}
spz_verbrauch_all
```

```{r}
i_subsection <- i_subsection+1
```

## `r i_section`.`r i_subsection`. Stadtbezirke, alle Wohngebäude, flächenbezogener Heizenergieverbrauch und beheizte Wohnfläche 2002 - 2018

Plot of the total area (to be combined with the specific energy consumption into one picture):

```{r}
###########################################################################################
#plot(2002:2018 , bezirk_areas_all$total,ylim=c(0,max(bezirk_areas_all$total)),col="blue")
#par(new=TRUE)
#plot(2002:2018, spz_verbrauch_all$kWh_per_m2,xlab="", ylab="", #ylim=c(0,max(spz_verbrauch_all$kWh_per_m2)), axes = FALSE)
###########################################################################################

#spz_verbrauch_all$kWh_per_m2
#make a function to plot two quantities, a dual plot, one on the left axis and the other on the right axis. Plot the linearized versions of these

plot_dualPlot <- function(y1 , y2 , x , xlab, ylab1 , ylab2, ylegend1, ylegend2) {
  dframe <- data.frame(x=x , y1=y1 , y2=y2)
 lm1 <- lm(y1~x , data = dframe)
 lm2 <- lm(y2~x , data = dframe)
 #replace with linear predictions
 y1 <- as.numeric(lm1$fitted.values)
 y2 <- as.numeric(lm2$fitted.values)
 
 par(mar=c(5, 4, 4, 6) + 0.1)
 plot(x,y1,ylim=c(0,max(y1)),col="black",xlab=xlab,ylab=ylab1,pch=16)
 
 par(new=TRUE)
 
 plot(x,y2,xlab="", ylab="", ylim=c(0,max(y2)), axes = FALSE , col = "red",pch=15)
 mtext(ylab2, side = 4, line = 4,col="red")
 axis(4, ylim=c(0,max(y2)), col="red",col.axis="red",las=1)

 legend("bottomleft", c(ylegend1, ylegend2),
       col = c("black", "red"), pch = c(16, 15))
 
}
```

```{r}
plot_dualPlot(bezirk_areas_all$total,
              spz_verbrauch_all$kWh_per_m2,
              2002:2018,
              "Jahr",
              "Area MFH + 1-2 FH Buildings (m2)",
              "TWh/m2",
              "Area",
              "Energy consumption per m2")
```











```{r}
i_section <- i_section + 1
i_subsection <- 1
```

# `r i_section`. Heizenergieverbrauch nach Stadtbezirken 2002 - 2018, 1-2 Familiengebäude 

## `r i_section`.`r i_subsection`. Stadtbezirke, 1-2 Familiengebäude, Heizenergieverbrauch 2002 - 2018 summiert 

* Total energy split by ET:
```{r}
by_ten_9 <- 1e-9
aes_by_ET_TWh_sfh <- by_ten_9 * co2_allebezirke_byET$aes_sfh
aes_by_ET_TWh_sfh$abrechnungsjahr <- 2002:2018
aes_by_ET_TWh_sfh_cumsums <- getCumSums(obj=aes_by_ET_TWh_sfh , dropCols = c("abrechnungsjahr","total"))
```

```{r}
points_line_lm(input_data = aes_by_ET_TWh_sfh,
               xVar = "abrechnungsjahr",
               yVar = "total",
               ymin = 0,
               ymax = max(aes_by_ET_TWh_sfh$total),
               x_eq = 2010,
               y_eq = 0.025,
               size_eq = 4,
               plot_title = "Total energy consumption in Berlin, 1-2 FH",
               xlab = "Jahr",
               ylab = "TWh",
               slope_round_to = 4)
```

```{r}
plot_byET(aes_by_ET_TWh_sfh_cumsums , xlabel = "Jahr" , ylabel = "TWh" , plottitle = NULL)
```


* Total energy split by bezirk:
```{r}
by_ten_9 <- 1e-9
aes_by_bezirk_TWh_sfh <- by_ten_9 * alle_bezirke_co2$aes_sfh
aes_by_bezirk_TWh_sfh$abrechnungsjahr <- 2002:2018
aes_by_bezirk_TWh_sfh_cumsums <- getCumSums(obj=aes_by_bezirk_TWh_sfh , dropCols = "abrechnungsjahr")
```

```{r}
plot_byBezirke(aes_by_bezirk_TWh_sfh_cumsums , xlabel = "Jahr" , ylabel = "TWh" , plottitle=NULL)
```





```{r}
i_subsection <- i_subsection+1
```

## `r i_section`.`r i_subsection`. Stadtbezirke, 1-2 Familiengebäude, Heizenergieverbrauch 2002 - 2018

(Eine Grafik: Heizenergieverbrauch aller 12 Bezirke in einer Grafik)
One Graph: All 12 lines in a single graph.

```{r}
aes_by_bezirk_TWh_sfh
```

```{r}
plot_reqdColumns(aes_by_bezirk_TWh_sfh,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(aes_by_bezirk_TWh_sfh)[!(names(aes_by_bezirk_TWh_sfh) %in% c("abrechnungsjahr"))],
                 yColsName = "Bezirk",
                 yVar = "Energy in TWh")
```


```{r,fig.height=10,fig.width=10}
max_aes_value <- max(aes_by_bezirk_TWh_sfh[ , names(aes_by_bezirk_TWh_sfh)[!(names(aes_by_bezirk_TWh_sfh) %in% c("abrechnungsjahr","total"))]])
require(ggplot2)
g_aes_bezirk <- list()
for (ii in 1:12) {
  g_aes_bezirk[[ii]] <- points_line_lm(input_data = aes_by_bezirk_TWh_sfh,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=0,
                                       ymax=max_aes_value,
                                       x_eq = 2010,
                                       y_eq = 0.5*max_aes_value,
                                       size_eq = 4,
                                       plot_title = bezirk_list[ii],
                                       xlab = "Jahr",
                                       ylab = "Energy in TWh",
                                       slope_round_to = 4,
                                       intercept_round_to = 2)
}
require(grid)
require(gridExtra)
grid.arrange(g_aes_bezirk[[1]],g_aes_bezirk[[2]],g_aes_bezirk[[3]],g_aes_bezirk[[4]],
             g_aes_bezirk[[5]],g_aes_bezirk[[6]],g_aes_bezirk[[7]],g_aes_bezirk[[8]],
             g_aes_bezirk[[9]],g_aes_bezirk[[10]],g_aes_bezirk[[11]],g_aes_bezirk[[12]],ncol=3)
```



```{r}
i_subsection <- i_subsection+1
```

## `r i_section`.`r i_subsection`. Stadtbezirke, 1-2 Familiengebäude, flächenbezogener Heizenergieverbrauch 2002 - 2018 in kWh/(m2[AN]*a) 



```{r}
spz_verbrauch_sfh <- data.frame(abrechnungsjahr=2002:2018,
                                kWh_per_m2 = 1e9 * aes_by_ET_TWh_sfh$total/bezirk_areas_sfh$total)
points_line_lm(input_data = spz_verbrauch_sfh,
               xVar = "abrechnungsjahr",
               yVar = "kWh_per_m2",
               ymin = 0,
               ymax = max(spz_verbrauch_sfh$kWh_per_m2),
               x_eq = 2010,
               y_eq = 1.25,
               size_eq = 4,
               plot_title = "Specific consumption, 1-2 FH",
               xlab = "Jahr",
               ylab = "kWh/m^2")
```



```{r}
i_subsection <- i_subsection+1
```

## `r i_section`.`r i_subsection`. Stadtbezirke, 1-2 Familiengebäude, flächenbezogener Heizenergieverbrauch und beheizte Wohnfläche 2002 - 2018

Plot of the 1-2 FH area (to be combined with the specific energy consumption into one picture):



```{r}
plot_dualPlot(bezirk_areas_sfh$total,
              spz_verbrauch_sfh$kWh_per_m2,
              2002:2018,
              "Jahr",
              "Area 1-2 FH Buildings (m2)",
              "TWh/m2",
              "Area",
              "Energy consumption per m2")
```

















```{r}
i_section <- i_section + 1
i_subsection <- 1
```

# `r i_section`. Heizenergieverbrauch nach Stadtbezirken 2002 - 2018, Mehrfamiliengebäude 

## `r i_section`.`r i_subsection`. Stadtbezirke, Mehrfamiliengebäude, Heizenergieverbrauch 2002 - 2018 summiert 

* Total energy split by ET:
```{r}
by_ten_9 <- 1e-9
aes_by_ET_TWh_mfh <- by_ten_9 * co2_allebezirke_byET$aes_mfh
aes_by_ET_TWh_mfh$abrechnungsjahr <- 2002:2018
aes_by_ET_TWh_mfh_cumsums <- getCumSums(obj=aes_by_ET_TWh_mfh , dropCols = c("abrechnungsjahr","total"))
```

```{r}
points_line_lm(input_data = aes_by_ET_TWh_mfh,
               xVar = "abrechnungsjahr",
               yVar = "total",
               ymin = 0,
               ymax = max(aes_by_ET_TWh_mfh$total),
               x_eq = 2010,
               y_eq = 0.025,
               size_eq = 4,
               plot_title = "Total energy consumption in Berlin, MFH",
               xlab = "Jahr",
               ylab = "TWh",
               slope_round_to = 4)
```

```{r}
plot_byET(aes_by_ET_TWh_mfh_cumsums , xlabel = "Jahr" , ylabel = "TWh" , plottitle = NULL)
```


* Total energy split by bezirk:
```{r}
by_ten_9 <- 1e-9
aes_by_bezirk_TWh_mfh <- by_ten_9 * alle_bezirke_co2$aes_mfh
aes_by_bezirk_TWh_mfh$abrechnungsjahr <- 2002:2018
aes_by_bezirk_TWh_mfh_cumsums <- getCumSums(obj=aes_by_bezirk_TWh_mfh , dropCols = "abrechnungsjahr")
```

```{r}
plot_byBezirke(aes_by_bezirk_TWh_mfh_cumsums , xlabel = "Jahr" , ylabel = "TWh" , plottitle=NULL)
```



```{r}
i_subsection <- i_subsection+1
```

## `r i_section`.`r i_subsection`. Stadtbezirke, Mehrfamiliengebäude Wohngebäude, Heizenergieverbrauch 2002 - 2018

(Eine Grafik: Heizenergieverbrauch aller 12 Bezirke in einer Grafik)
One Graph: All 12 lines in a single graph.

```{r}
aes_by_bezirk_TWh_mfh
```

```{r}
plot_reqdColumns(aes_by_bezirk_TWh_mfh,
                 xVar = "abrechnungsjahr",
                 cols_to_plot = names(aes_by_bezirk_TWh_mfh)[!(names(aes_by_bezirk_TWh_mfh) %in% c("abrechnungsjahr"))],
                 yColsName = "Bezirk",
                 yVar = "Energy in TWh")
```
                 
                 
```{r,fig.height=10,fig.width=10}
max_aes_value <- max(aes_by_bezirk_TWh_mfh[ , names(aes_by_bezirk_TWh_mfh)[!(names(aes_by_bezirk_TWh_mfh) %in% c("abrechnungsjahr","total"))]])
require(ggplot2)
g_aes_bezirk <- list()
for (ii in 1:12) {
  g_aes_bezirk[[ii]] <- points_line_lm(input_data = aes_by_bezirk_TWh_mfh,
                                       xVar = "abrechnungsjahr",
                                       yVar = bezirk_list[ii],
                                       ymin=0,
                                       ymax=max_aes_value,
                                       x_eq = 2010,
                                       y_eq = 0.5*max_aes_value,
                                       size_eq = 4,
                                       plot_title = bezirk_list[ii],
                                       xlab = "Jahr",
                                       ylab = "Energy in TWh",
                                       slope_round_to = 4,
                                       intercept_round_to = 2)
}
require(grid)
require(gridExtra)
grid.arrange(g_aes_bezirk[[1]],g_aes_bezirk[[2]],g_aes_bezirk[[3]],g_aes_bezirk[[4]],
             g_aes_bezirk[[5]],g_aes_bezirk[[6]],g_aes_bezirk[[7]],g_aes_bezirk[[8]],
             g_aes_bezirk[[9]],g_aes_bezirk[[10]],g_aes_bezirk[[11]],g_aes_bezirk[[12]],ncol=3)     
```                 
                 
                 

```{r}
i_subsection <- i_subsection+1
```

## `r i_section`.`r i_subsection`. Stadtbezirke, Mehrfamiliengebäude, flächenbezogener Heizenergieverbrauch 2002 - 2018 in kWh/(m2[AN]*a) 



```{r}
spz_verbrauch_mfh <- data.frame(abrechnungsjahr=2002:2018,
                                kWh_per_m2 = 1e9 * aes_by_ET_TWh_mfh$total/bezirk_areas_mfh$total)
points_line_lm(input_data = spz_verbrauch_mfh,
               xVar = "abrechnungsjahr",
               yVar = "kWh_per_m2",
               ymin = 0,
               ymax = max(spz_verbrauch_mfh$kWh_per_m2),
               x_eq = 2010,
               y_eq = 1.1,
               size_eq = 4,
               plot_title = "Specific consumption, MFH",
               xlab = "Jahr",
               ylab = "kWh/m^2")
```



```{r}
i_subsection <- i_subsection+1
```

## `r i_section`.`r i_subsection`. Stadtbezirke, Mehrfamiliengebäude, flächenbezogener Heizenergieverbrauch und beheizte Wohnfläche 2002 - 2018

Plot of the MFH area (to be combined with the specific energy consumption into one picture):

```{r}
plot_dualPlot(bezirk_areas_mfh$total,
              spz_verbrauch_mfh$kWh_per_m2,
              2002:2018,
              "Jahr",
              "Area MFH Buildings (m2)",
              "TWh/m2",
              "Area",
              "Energy consumption per m2")
```


# <font size="20">Teil 2.</font>

```{r}
extract_co2_emission <- function(obj_sfh , obj_mfh) {
  co2_SFH <- obj_sfh$co2_emissions 
  co2_MFH <- obj_mfh$co2_emissions 
  co2_SFH$strom[co2_SFH$abrechnungsjahr < 2010] <- mean(co2_SFH$strom[co2_SFH$abrechnungsjahr >2009])
  co2_MFH$strom[co2_MFH$abrechnungsjahr < 2010] <- mean(co2_MFH$strom[co2_MFH$abrechnungsjahr >2009])
  #recalculate "total" column
  co2_SFH <- getRowSums(co2_SFH[,names(co2_SFH)!="total"] , dropCols = "abrechnungsjahr")
  co2_MFH <- getRowSums(co2_MFH[,names(co2_MFH)!="total"] , dropCols = "abrechnungsjahr")
  #---
  co2_ALL <- co2_SFH + co2_MFH
  co2_ALL$abrechnungsjahr <- 2002:2018
  co2_SFH <- co2_SFH/1e7
  co2_MFH <- co2_MFH/1e7
  co2_ALL <- co2_ALL/1e7
  co2_SFH$abrechnungsjahr <- 2002:2018
  co2_MFH$abrechnungsjahr <- 2002:2018
  co2_ALL$abrechnungsjahr <- 2002:2018
  
  return_data <- list()
  return_data$SFH <- co2_SFH
  return_data$MFH <- co2_MFH
  return_data$ALL <- co2_ALL
  return(return_data)
}

extract_aes <- function(obj_sfh , obj_mfh) {
  aes_SFH <- obj_sfh$energy_shares_absolute
  aes_MFH <- obj_mfh$energy_shares_absolute
  aes_SFH$strom[aes_SFH$abrechnungsjahr < 2010] <- mean(aes_SFH$strom[aes_SFH$abrechnungsjahr >2009])
  aes_MFH$strom[aes_MFH$abrechnungsjahr < 2010] <- mean(aes_MFH$strom[aes_MFH$abrechnungsjahr >2009])
  aes_SFH <- getRowSums(aes_SFH , dropCols = "abrechnungsjahr")
  aes_MFH <- getRowSums(aes_MFH , dropCols = "abrechnungsjahr")
  aes_ALL <- aes_SFH + aes_MFH
  aes_ALL$abrechnungsjahr <- 2002:2018
  
  return_data <- list()
  return_data$SFH <- aes_SFH
  return_data$MFH <- aes_MFH
  return_data$ALL <- aes_ALL
  return(return_data)
}
```

```{r}
bezirk_proper_names  <- c(
  "Charlottenburg-Wilmersdorf",
  "Friedrichshain-Kreuzberg",
  "Lichtenberg",
  "Marzahn-Hellersdorf",
  "Mitte",
  "Neukölln",
  "Pankow"    ,             
  "Reinickendorf",
  "Spandau",
  "Steglitz-Zehlendorf" ,
  "Tempelhof-Schöneberg",
  "Treptow-Köpenick"                              
)

bezirk_list  <- c(
  "charlottenburg_wilmersdorf",
  "friedrichshain_kreuzberg",
  "lichtenberg",
  "marzahn_hellersdorf",
  "mitte",
  "neukoelln",
  "pankow"    ,             
  "reinickendorf",
  "spandau",
  "steglitz_zehlendorf" ,
  "tempelhof_schoeneberg",
  "treptow_koepenick"                              
)
```


```{r}
i_bezirk <- 0
```





```{r}
i_bezirk           <- i_bezirk + 1
bezirk             <- bezirk_list[i_bezirk]
bezirk_proper_name <- bezirk_proper_names[i_bezirk]
et_list <- c("erdgas","waerme","fluessiggas","heizoel","holzpellets","strom")
```

```{r}
i_section <- i_section + 1
i_subsection <- 0
i_subsubsection <- 0
```

# `r bezirk_proper_name`

# `r i_section`.`r bezirk_proper_name`, alle Wohngebäude, CO2-Emission aus Beheizung 2002  2018 

```{r}
i_subsection <- i_subsection + 1
```

## `r i_section`.`r i_subsection` Absolute Zahlen

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`, alle Wohngebäude, CO2-Emission aus Beheizung 2002 - 2018 in units

```{r}
return_SFH <- main_function("SFH" , bezirk , et_list)
return_MFH <- main_function("MFH" , bezirk , et_list)
return_co2 <- extract_co2_emission(return_SFH , return_MFH)
return_aes <- extract_aes(return_SFH , return_MFH) #this you can put in the section dealing with energy.
```

Here you need just the total co2 emitted, not split by ET.
```{r}
bezirk_co2_all <- return_co2$ALL
```

```{r}
points_line_lm(input_data = bezirk_co2_all,
               xVar = "abrechnungsjahr",
               yVar = "total",
               ymin = 0,
               ymax = max(bezirk_co2_all$total),
               x_eq = 2010,
               y_eq = 300,
               size_eq = 4,
               plot_title = paste0("CO2 emissions in ",bezirk_proper_name, " All buildings"),
               xlab = "Jahr",
               ylab = "kilo t.")
```

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`, alle Wohngebäude, CO2-Emission aus Beheizung 2002 - 2018 nach Energieträgern, Anteile in units CO2, summiert

Here you need to split by ET
```{r}
bezirk_co2_all_cumsums <- getCumSums(bezirk_co2_all , dropCols = c("abrechnungsjahr","total"))
plot_byET(bezirk_co2_all_cumsums , xlabel = "Jahr" , ylabel = "kilo t." , plottitle = paste0("CO2 Emissions All buildings ",bezirk_proper_name) )
```




```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`, alle Wohngebäude, Emission aus Beheizung 2002 - 2018 nach Energieträgern, Anteile in %

```{r}
bezirk_co2_all_prop <- find_proportions(bezirk_co2_all,drop_cols = c("abrechnungsjahr","total"))
bezirk_co2_all_prop_cumsums <- getCumSums(bezirk_co2_all_prop,dropCols="abrechnungsjahr")
plot_byET(bezirk_co2_all_prop_cumsums , xlabel = "Jahr" , ylabel = "Anteile in %" , plottitle = paste0("CO2 Emissions All buildings ",bezirk_proper_name) )
```

```{r}
i_subsection <- i_subsection + 1
i_subsubsection <- 0
```

## `r i_section`.`r i_subsection`. Flächenbezug

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. alle Wohngebäude, flächenbezogene Emission aus Beheizung 2002 - 2018

```{r}
bezirk_total_area <- return_SFH$totalArea
bezirk_total_area$areaALL <- bezirk_total_area$areaSFH + bezirk_total_area$areaMFH
bezirk_total_area <- 100*bezirk_total_area
bezirk_total_area$abrechnungsjahr <- 2002:2018
```

```{r}
bezirk_spzco2_all <- data.frame(abrechnungsjahr=2002:2018 ,   spzco2 = 1e6*(bezirk_co2_all$total / bezirk_total_area$areaALL) )
bezirk_spzco2_all
```

```{r}
points_line_lm(input_data = bezirk_spzco2_all,
               xVar = "abrechnungsjahr",
               yVar = "spzco2",
               ymin=0,
               ymax=max(bezirk_spzco2_all$spzco2),
               x_eq = 2010,
               y_eq = 20,
               size_eq = 4,
               plot_title = paste0("Specific CO2 emissions, All buildings ",bezirk_proper_name),
               xlab = "Jahr",
               ylab = "kg/qm")
```



<font size="12">Isn't it strange that the above graph has almost exactly the same shape as total co2 emissions?</font>

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. alle Wohngebäude, flächenbezogene CO2-Emssion und beheizte Wohnfläche 2002  2018

```{r}
plot(bezirk_total_area$abrechnungsjahr , bezirk_total_area$areaALL)
```

```{r}
i_subsection <- i_subsection + 1
i_subsubsection <- 0
```

## `r i_section`.`r i_subsection`. Emission pro Einwohner

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. alle Wohngebäude, CO2-Emission aus der Beheizung von Wohnraum pro Einwohner 2002 - 2018

* Need data for this.

```{r}
i_subsection <- i_subsection + 1
i_subsubsection <- 0
```

## `r i_section`.`r i_subsection`. Prognose

```{r}
i_subsubsection <- i_subsubsection + 1
```

### `r i_section`.`r i_subsection`.`r i_subsubsection`. Alle Stadtbezirke, Prognose der CO2-Emission aus Behei¬zung von 1-2 Familiengebäuden 2019 - 2030 in Mio. t (Trend Polynom 2. Grades)

**Are you sure this is for Alle Stadtbezirke?**

```{r}
i_subsection <- i_subsection + 1
i_subsubsection <- 0
```

## `r i_section`.`r i_subsection`. Einflussfaktoren